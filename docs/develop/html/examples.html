
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>Tutorials &#8212; ESMPy 8.1.0 beta snapshot documentation</title>
    <link rel="stylesheet" href="_static/classic.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    
    <script type="text/javascript" id="documentation_options" data-url_root="./" src="_static/documentation_options.js"></script>
    <script type="text/javascript" src="_static/jquery.js"></script>
    <script type="text/javascript" src="_static/underscore.js"></script>
    <script type="text/javascript" src="_static/doctools.js"></script>
    <script type="text/javascript" src="_static/language_data.js"></script>
    
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="API" href="api.html" />
    <link rel="prev" title="Installation" href="install.html" /> 
  </head><body>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="api.html" title="API"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="install.html" title="Installation"
             accesskey="P">previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="index.html">ESMPy 8.1.0 beta snapshot documentation</a> &#187;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <div class="section" id="tutorials">
<h1>Tutorials<a class="headerlink" href="#tutorials" title="Permalink to this headline">¶</a></h1>
<div class="section" id="hello-world">
<h2>Hello World<a class="headerlink" href="#hello-world" title="Permalink to this headline">¶</a></h2>
<blockquote>
<div><div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">ESMF</span>

<span class="c1"># This call enables debug logging</span>
<span class="c1"># esmpy = ESMF.Manager(debug=True)</span>

<span class="nb">print</span> <span class="p">(</span><span class="s2">&quot;Hello ESMPy World from PET (processor) </span><span class="si">{0}</span><span class="s2">!&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ESMF</span><span class="o">.</span><span class="n">local_pet</span><span class="p">()))</span>
</pre></div>
</div>
</div></blockquote>
</div>
<div class="section" id="regridding-helper-functions">
<h2>Regridding Helper Functions<a class="headerlink" href="#regridding-helper-functions" title="Permalink to this headline">¶</a></h2>
<p>The following code snippets demonstrate how to build all of the pieces
necessary to regrid data between <a class="reference internal" href="field.html#ESMF.api.field.Field" title="ESMF.api.field.Field"><code class="xref py py-class docutils literal notranslate"><span class="pre">Fields</span></code></a> built on
<a class="reference internal" href="grid.html#ESMF.api.grid.Grid" title="ESMF.api.grid.Grid"><code class="xref py py-class docutils literal notranslate"><span class="pre">Grids</span></code></a>, <a class="reference internal" href="mesh.html#ESMF.api.mesh.Mesh" title="ESMF.api.mesh.Mesh"><code class="xref py py-class docutils literal notranslate"><span class="pre">Meshes</span></code></a>
and <a class="reference internal" href="locstream.html#ESMF.api.locstream.LocStream" title="ESMF.api.locstream.LocStream"><code class="xref py py-class docutils literal notranslate"><span class="pre">LocStreams</span></code></a>.</p>
<div class="section" id="locstream-create">
<h3>LocStream Create<a class="headerlink" href="#locstream-create" title="Permalink to this headline">¶</a></h3>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">create_locstream_spherical_16</span><span class="p">(</span><span class="n">coord_sys</span><span class="o">=</span><span class="n">ESMF</span><span class="o">.</span><span class="n">CoordSys</span><span class="o">.</span><span class="n">SPH_DEG</span><span class="p">,</span> <span class="n">domask</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    :param coord_sys: the coordinate system of the LocStream</span>
<span class="sd">    :param domask: a boolean to tell whether or not to add a mask</span>
<span class="sd">    :return: LocStream</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">ESMF</span><span class="o">.</span><span class="n">pet_count</span><span class="p">()</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;processor count must be 1 to use this function&quot;</span><span class="p">)</span>

    <span class="n">locstream</span> <span class="o">=</span> <span class="n">ESMF</span><span class="o">.</span><span class="n">LocStream</span><span class="p">(</span><span class="mi">16</span><span class="p">,</span> <span class="n">coord_sys</span><span class="o">=</span><span class="n">coord_sys</span><span class="p">)</span>

    <span class="n">deg_rad</span> <span class="o">=</span> <span class="n">pi</span>
    <span class="k">if</span> <span class="n">coord_sys</span> <span class="o">==</span> <span class="n">ESMF</span><span class="o">.</span><span class="n">CoordSys</span><span class="o">.</span><span class="n">SPH_DEG</span><span class="p">:</span>
        <span class="n">deg_rad</span> <span class="o">=</span> <span class="mi">180</span>

    <span class="n">locstream</span><span class="p">[</span><span class="s2">&quot;ESMF:Lon&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.5</span><span class="o">*</span><span class="n">deg_rad</span><span class="p">,</span> <span class="mf">1.5</span><span class="o">*</span><span class="n">deg_rad</span><span class="p">,</span> <span class="mi">2</span><span class="o">*</span><span class="n">deg_rad</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.5</span><span class="o">*</span><span class="n">deg_rad</span><span class="p">,</span> <span class="mf">1.5</span><span class="o">*</span><span class="n">deg_rad</span><span class="p">,</span> <span class="mi">2</span><span class="o">*</span><span class="n">deg_rad</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.5</span><span class="o">*</span><span class="n">deg_rad</span><span class="p">,</span> <span class="mf">1.5</span><span class="o">*</span><span class="n">deg_rad</span><span class="p">,</span> <span class="mi">2</span><span class="o">*</span><span class="n">deg_rad</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.5</span><span class="o">*</span><span class="n">deg_rad</span><span class="p">,</span> <span class="mf">1.5</span><span class="o">*</span><span class="n">deg_rad</span><span class="p">,</span> <span class="mi">2</span><span class="o">*</span><span class="n">deg_rad</span><span class="p">]</span>
    <span class="n">locstream</span><span class="p">[</span><span class="s2">&quot;ESMF:Lat&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">deg_rad</span><span class="o">/-</span><span class="mf">2.0</span><span class="p">,</span> <span class="n">deg_rad</span><span class="o">/-</span><span class="mf">2.0</span><span class="p">,</span> <span class="n">deg_rad</span><span class="o">/-</span><span class="mf">2.0</span><span class="p">,</span> <span class="n">deg_rad</span><span class="o">/-</span><span class="mf">2.0</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.25</span><span class="o">*</span><span class="n">deg_rad</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.25</span><span class="o">*</span><span class="n">deg_rad</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.25</span><span class="o">*</span><span class="n">deg_rad</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.25</span><span class="o">*</span><span class="n">deg_rad</span><span class="p">,</span> <span class="mf">0.25</span><span class="o">*</span><span class="n">deg_rad</span><span class="p">,</span> <span class="mf">0.25</span><span class="o">*</span><span class="n">deg_rad</span><span class="p">,</span> <span class="mf">0.25</span><span class="o">*</span><span class="n">deg_rad</span><span class="p">,</span> <span class="mf">0.25</span><span class="o">*</span><span class="n">deg_rad</span><span class="p">,</span> <span class="n">deg_rad</span><span class="o">/</span><span class="mf">2.0</span><span class="p">,</span> <span class="n">deg_rad</span><span class="o">/</span><span class="mf">2.0</span><span class="p">,</span> <span class="n">deg_rad</span><span class="o">/</span><span class="mf">2.0</span><span class="p">,</span> <span class="n">deg_rad</span><span class="o">/</span><span class="mf">2.0</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">domask</span><span class="p">:</span>
        <span class="n">locstream</span><span class="p">[</span><span class="s2">&quot;ESMF:Mask&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">locstream</span>
</pre></div>
</div>
</div>
<div class="section" id="locstream-create-parallel">
<h3>LocStream Create Parallel<a class="headerlink" href="#locstream-create-parallel" title="Permalink to this headline">¶</a></h3>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">create_locstream_spherical_16_parallel</span><span class="p">(</span><span class="n">coord_sys</span><span class="o">=</span><span class="n">ESMF</span><span class="o">.</span><span class="n">CoordSys</span><span class="o">.</span><span class="n">SPH_DEG</span><span class="p">,</span> <span class="n">domask</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    :param coord_sys: the coordinate system of the LocStream</span>
<span class="sd">    :param domask: a boolean to tell whether or not to add a mask</span>
<span class="sd">    :return: LocStream</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">ESMF</span><span class="o">.</span><span class="n">pet_count</span><span class="p">()</span> <span class="o">!=</span> <span class="mi">4</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;processor count must be 4 to use this function&quot;</span><span class="p">)</span>

    <span class="n">deg_rad</span> <span class="o">=</span> <span class="n">pi</span>
    <span class="k">if</span> <span class="n">coord_sys</span> <span class="o">==</span> <span class="n">ESMF</span><span class="o">.</span><span class="n">CoordSys</span><span class="o">.</span><span class="n">SPH_DEG</span><span class="p">:</span>
        <span class="n">deg_rad</span> <span class="o">=</span> <span class="mf">180.0</span>

    <span class="n">locstream</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="n">ESMF</span><span class="o">.</span><span class="n">local_pet</span><span class="p">()</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">locstream</span> <span class="o">=</span> <span class="n">ESMF</span><span class="o">.</span><span class="n">LocStream</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="n">coord_sys</span><span class="o">=</span><span class="n">coord_sys</span><span class="p">)</span>
        <span class="n">locstream</span><span class="p">[</span><span class="s2">&quot;ESMF:Lon&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.5</span><span class="o">*</span><span class="n">deg_rad</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.5</span><span class="o">*</span><span class="n">deg_rad</span><span class="p">]</span>
        <span class="n">locstream</span><span class="p">[</span><span class="s2">&quot;ESMF:Lat&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">deg_rad</span><span class="o">/-</span><span class="mf">2.0</span><span class="p">,</span> <span class="n">deg_rad</span><span class="o">/-</span><span class="mf">2.0</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.25</span><span class="o">*</span><span class="n">deg_rad</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.25</span><span class="o">*</span><span class="n">deg_rad</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">domask</span><span class="p">:</span>
            <span class="n">locstream</span><span class="p">[</span><span class="s2">&quot;ESMF:Mask&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">ESMF</span><span class="o">.</span><span class="n">local_pet</span><span class="p">()</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">locstream</span> <span class="o">=</span> <span class="n">ESMF</span><span class="o">.</span><span class="n">LocStream</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="n">coord_sys</span><span class="o">=</span><span class="n">coord_sys</span><span class="p">)</span>
        <span class="n">locstream</span><span class="p">[</span><span class="s2">&quot;ESMF:Lon&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="mf">1.5</span><span class="o">*</span><span class="n">deg_rad</span><span class="p">,</span> <span class="mi">2</span><span class="o">*</span><span class="n">deg_rad</span><span class="p">,</span> <span class="mf">1.5</span><span class="o">*</span><span class="n">deg_rad</span><span class="p">,</span> <span class="mi">2</span><span class="o">*</span><span class="n">deg_rad</span><span class="p">]</span>
        <span class="n">locstream</span><span class="p">[</span><span class="s2">&quot;ESMF:Lat&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">deg_rad</span><span class="o">/-</span><span class="mf">2.0</span><span class="p">,</span> <span class="n">deg_rad</span><span class="o">/-</span><span class="mf">2.0</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.25</span><span class="o">*</span><span class="n">deg_rad</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.25</span><span class="o">*</span><span class="n">deg_rad</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">domask</span><span class="p">:</span>
            <span class="n">locstream</span><span class="p">[</span><span class="s2">&quot;ESMF:Mask&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">ESMF</span><span class="o">.</span><span class="n">local_pet</span><span class="p">()</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
        <span class="n">locstream</span> <span class="o">=</span> <span class="n">ESMF</span><span class="o">.</span><span class="n">LocStream</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="n">coord_sys</span><span class="o">=</span><span class="n">coord_sys</span><span class="p">)</span>
        <span class="n">locstream</span><span class="p">[</span><span class="s2">&quot;ESMF:Lon&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.5</span><span class="o">*</span><span class="n">deg_rad</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.5</span><span class="o">*</span><span class="n">deg_rad</span><span class="p">]</span>
        <span class="n">locstream</span><span class="p">[</span><span class="s2">&quot;ESMF:Lat&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.25</span><span class="o">*</span><span class="n">deg_rad</span><span class="p">,</span> <span class="mf">0.25</span><span class="o">*</span><span class="n">deg_rad</span><span class="p">,</span> <span class="n">deg_rad</span><span class="o">/</span><span class="mf">2.0</span><span class="p">,</span> <span class="n">deg_rad</span><span class="o">/</span><span class="mf">2.0</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">domask</span><span class="p">:</span>
            <span class="n">locstream</span><span class="p">[</span><span class="s2">&quot;ESMF:Mask&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">ESMF</span><span class="o">.</span><span class="n">local_pet</span><span class="p">()</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
        <span class="n">locstream</span> <span class="o">=</span> <span class="n">ESMF</span><span class="o">.</span><span class="n">LocStream</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="n">coord_sys</span><span class="o">=</span><span class="n">coord_sys</span><span class="p">)</span>
        <span class="n">locstream</span><span class="p">[</span><span class="s2">&quot;ESMF:Lon&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="mf">1.5</span><span class="o">*</span><span class="n">deg_rad</span><span class="p">,</span> <span class="mi">2</span><span class="o">*</span><span class="n">deg_rad</span><span class="p">,</span> <span class="mf">1.5</span><span class="o">*</span><span class="n">deg_rad</span><span class="p">,</span> <span class="mi">2</span><span class="o">*</span><span class="n">deg_rad</span><span class="p">]</span>
        <span class="n">locstream</span><span class="p">[</span><span class="s2">&quot;ESMF:Lat&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.25</span><span class="o">*</span><span class="n">deg_rad</span><span class="p">,</span> <span class="mf">0.25</span><span class="o">*</span><span class="n">deg_rad</span><span class="p">,</span> <span class="n">deg_rad</span><span class="o">/</span><span class="mf">2.0</span><span class="p">,</span> <span class="n">deg_rad</span><span class="o">/</span><span class="mf">2.0</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">domask</span><span class="p">:</span>
            <span class="n">locstream</span><span class="p">[</span><span class="s2">&quot;ESMF:Mask&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">locstream</span>
</pre></div>
</div>
</div>
<div class="section" id="create-a-2d-grid">
<h3>Create a 2D Grid<a class="headerlink" href="#create-a-2d-grid" title="Permalink to this headline">¶</a></h3>
<blockquote>
<div><div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">grid_create_from_coordinates</span><span class="p">(</span><span class="n">xcoords</span><span class="p">,</span> <span class="n">ycoords</span><span class="p">,</span> <span class="n">xcorners</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">ycorners</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">corners</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">domask</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">doarea</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">ctk</span><span class="o">=</span><span class="n">ESMF</span><span class="o">.</span><span class="n">TypeKind</span><span class="o">.</span><span class="n">R8</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Create a 2 dimensional Grid using the bounds of the x and y coordiantes.</span>
<span class="sd">    :param xcoords: The 1st dimension or &#39;x&#39; coordinates at cell centers, as a Python list or numpy Array</span>
<span class="sd">    :param ycoords: The 2nd dimension or &#39;y&#39; coordinates at cell centers, as a Python list or numpy Array</span>
<span class="sd">    :param xcorners: The 1st dimension or &#39;x&#39; coordinates at cell corners, as a Python list or numpy Array</span>
<span class="sd">    :param ycorners: The 2nd dimension or &#39;y&#39; coordinates at cell corners, as a Python list or numpy Array</span>
<span class="sd">    :param domask: boolean to determine whether to set an arbitrary mask or not</span>
<span class="sd">    :param doarea: boolean to determine whether to set an arbitrary area values or not</span>
<span class="sd">    :param ctk: the coordinate typekind</span>
<span class="sd">    :return: grid</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="p">[</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>

    <span class="c1"># create a grid given the number of grid cells in each dimension, the center stagger location is allocated, the</span>
    <span class="c1"># Cartesian coordinate system and type of the coordinates are specified</span>
    <span class="n">max_index</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="nb">len</span><span class="p">(</span><span class="n">xcoords</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">ycoords</span><span class="p">)])</span>
    <span class="n">grid</span> <span class="o">=</span> <span class="n">ESMF</span><span class="o">.</span><span class="n">Grid</span><span class="p">(</span><span class="n">max_index</span><span class="p">,</span> <span class="n">staggerloc</span><span class="o">=</span><span class="p">[</span><span class="n">ESMF</span><span class="o">.</span><span class="n">StaggerLoc</span><span class="o">.</span><span class="n">CENTER</span><span class="p">],</span> <span class="n">coord_sys</span><span class="o">=</span><span class="n">ESMF</span><span class="o">.</span><span class="n">CoordSys</span><span class="o">.</span><span class="n">CART</span><span class="p">,</span> <span class="n">coord_typekind</span><span class="o">=</span><span class="n">ctk</span><span class="p">)</span>

    <span class="c1"># set the grid coordinates using numpy arrays, parallel case is handled using grid bounds</span>
    <span class="n">gridXCenter</span> <span class="o">=</span> <span class="n">grid</span><span class="o">.</span><span class="n">get_coords</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="n">x_par</span> <span class="o">=</span> <span class="n">xcoords</span><span class="p">[</span><span class="n">grid</span><span class="o">.</span><span class="n">lower_bounds</span><span class="p">[</span><span class="n">ESMF</span><span class="o">.</span><span class="n">StaggerLoc</span><span class="o">.</span><span class="n">CENTER</span><span class="p">][</span><span class="n">x</span><span class="p">]:</span><span class="n">grid</span><span class="o">.</span><span class="n">upper_bounds</span><span class="p">[</span><span class="n">ESMF</span><span class="o">.</span><span class="n">StaggerLoc</span><span class="o">.</span><span class="n">CENTER</span><span class="p">][</span><span class="n">x</span><span class="p">]]</span>
    <span class="n">gridXCenter</span><span class="p">[</span><span class="o">...</span><span class="p">]</span> <span class="o">=</span> <span class="n">x_par</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">x_par</span><span class="o">.</span><span class="n">size</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>

    <span class="n">gridYCenter</span> <span class="o">=</span> <span class="n">grid</span><span class="o">.</span><span class="n">get_coords</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
    <span class="n">y_par</span> <span class="o">=</span> <span class="n">ycoords</span><span class="p">[</span><span class="n">grid</span><span class="o">.</span><span class="n">lower_bounds</span><span class="p">[</span><span class="n">ESMF</span><span class="o">.</span><span class="n">StaggerLoc</span><span class="o">.</span><span class="n">CENTER</span><span class="p">][</span><span class="n">y</span><span class="p">]:</span><span class="n">grid</span><span class="o">.</span><span class="n">upper_bounds</span><span class="p">[</span><span class="n">ESMF</span><span class="o">.</span><span class="n">StaggerLoc</span><span class="o">.</span><span class="n">CENTER</span><span class="p">][</span><span class="n">y</span><span class="p">]]</span>
    <span class="n">gridYCenter</span><span class="p">[</span><span class="o">...</span><span class="p">]</span> <span class="o">=</span> <span class="n">y_par</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span> <span class="n">y_par</span><span class="o">.</span><span class="n">size</span><span class="p">))</span>

    <span class="c1"># create grid corners in a slightly different manner to account for the bounds format common in CF-like files</span>
    <span class="k">if</span> <span class="n">corners</span><span class="p">:</span>
        <span class="n">grid</span><span class="o">.</span><span class="n">add_coords</span><span class="p">([</span><span class="n">ESMF</span><span class="o">.</span><span class="n">StaggerLoc</span><span class="o">.</span><span class="n">CORNER</span><span class="p">])</span>
        <span class="n">lbx</span> <span class="o">=</span> <span class="n">grid</span><span class="o">.</span><span class="n">lower_bounds</span><span class="p">[</span><span class="n">ESMF</span><span class="o">.</span><span class="n">StaggerLoc</span><span class="o">.</span><span class="n">CORNER</span><span class="p">][</span><span class="n">x</span><span class="p">]</span>
        <span class="n">ubx</span> <span class="o">=</span> <span class="n">grid</span><span class="o">.</span><span class="n">upper_bounds</span><span class="p">[</span><span class="n">ESMF</span><span class="o">.</span><span class="n">StaggerLoc</span><span class="o">.</span><span class="n">CORNER</span><span class="p">][</span><span class="n">x</span><span class="p">]</span>
        <span class="n">lby</span> <span class="o">=</span> <span class="n">grid</span><span class="o">.</span><span class="n">lower_bounds</span><span class="p">[</span><span class="n">ESMF</span><span class="o">.</span><span class="n">StaggerLoc</span><span class="o">.</span><span class="n">CORNER</span><span class="p">][</span><span class="n">y</span><span class="p">]</span>
        <span class="n">uby</span> <span class="o">=</span> <span class="n">grid</span><span class="o">.</span><span class="n">upper_bounds</span><span class="p">[</span><span class="n">ESMF</span><span class="o">.</span><span class="n">StaggerLoc</span><span class="o">.</span><span class="n">CORNER</span><span class="p">][</span><span class="n">y</span><span class="p">]</span>

        <span class="n">gridXCorner</span> <span class="o">=</span> <span class="n">grid</span><span class="o">.</span><span class="n">get_coords</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">staggerloc</span><span class="o">=</span><span class="n">ESMF</span><span class="o">.</span><span class="n">StaggerLoc</span><span class="o">.</span><span class="n">CORNER</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i0</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ubx</span> <span class="o">-</span> <span class="n">lbx</span> <span class="o">-</span> <span class="mi">1</span><span class="p">):</span>
            <span class="n">gridXCorner</span><span class="p">[</span><span class="n">i0</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">xcorners</span><span class="p">[</span><span class="n">i0</span><span class="o">+</span><span class="n">lbx</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
        <span class="n">gridXCorner</span><span class="p">[</span><span class="n">i0</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">xcorners</span><span class="p">[</span><span class="n">i0</span><span class="o">+</span><span class="n">lbx</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>

        <span class="n">gridYCorner</span> <span class="o">=</span> <span class="n">grid</span><span class="o">.</span><span class="n">get_coords</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">staggerloc</span><span class="o">=</span><span class="n">ESMF</span><span class="o">.</span><span class="n">StaggerLoc</span><span class="o">.</span><span class="n">CORNER</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i1</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">uby</span> <span class="o">-</span> <span class="n">lby</span> <span class="o">-</span> <span class="mi">1</span><span class="p">):</span>
            <span class="n">gridYCorner</span><span class="p">[:,</span> <span class="n">i1</span><span class="p">]</span> <span class="o">=</span> <span class="n">ycorners</span><span class="p">[</span><span class="n">i1</span><span class="o">+</span><span class="n">lby</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
        <span class="n">gridYCorner</span><span class="p">[:,</span> <span class="n">i1</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">ycorners</span><span class="p">[</span><span class="n">i1</span><span class="o">+</span><span class="n">lby</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>

    <span class="c1"># add an arbitrary mask</span>
    <span class="k">if</span> <span class="n">domask</span><span class="p">:</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="n">grid</span><span class="o">.</span><span class="n">add_item</span><span class="p">(</span><span class="n">ESMF</span><span class="o">.</span><span class="n">GridItem</span><span class="o">.</span><span class="n">MASK</span><span class="p">)</span>
        <span class="n">mask</span><span class="p">[:]</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">mask</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">((</span><span class="mf">1.75</span> <span class="o">&lt;=</span> <span class="n">gridXCenter</span><span class="o">.</span><span class="n">any</span><span class="p">()</span> <span class="o">&lt;</span> <span class="mf">2.25</span><span class="p">)</span> <span class="o">&amp;</span>
                      <span class="p">(</span><span class="mf">1.75</span> <span class="o">&lt;=</span> <span class="n">gridYCenter</span><span class="o">.</span><span class="n">any</span><span class="p">()</span> <span class="o">&lt;</span> <span class="mf">2.25</span><span class="p">))]</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="c1"># add arbitrary areas values</span>
    <span class="k">if</span> <span class="n">doarea</span><span class="p">:</span>
        <span class="n">area</span> <span class="o">=</span> <span class="n">grid</span><span class="o">.</span><span class="n">add_item</span><span class="p">(</span><span class="n">ESMF</span><span class="o">.</span><span class="n">GridItem</span><span class="o">.</span><span class="n">AREA</span><span class="p">)</span>
        <span class="n">area</span><span class="p">[:]</span> <span class="o">=</span> <span class="mf">5.0</span>

    <span class="k">return</span> <span class="n">grid</span>
</pre></div>
</div>
</div></blockquote>
</div>
<div class="section" id="create-a-3d-grid">
<h3>Create a 3D Grid<a class="headerlink" href="#create-a-3d-grid" title="Permalink to this headline">¶</a></h3>
<blockquote>
<div><div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">grid_create_from_coordinates_3d</span><span class="p">(</span><span class="n">xcoords</span><span class="p">,</span> <span class="n">ycoords</span><span class="p">,</span> <span class="n">zcoords</span><span class="p">,</span> <span class="n">xcorners</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">ycorners</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">zcorners</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">corners</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">domask</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">doarea</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Create a 3 dimensional Grid using the xcoordinates, ycoordinates and zcoordinates.</span>
<span class="sd">    :param xcoords: The 1st dimension or &#39;x&#39; coordinates at cell centers, as a Python list or numpy Array</span>
<span class="sd">    :param ycoords: The 2nd dimension or &#39;y&#39; coordinates at cell centers, as a Python list or numpy Array</span>
<span class="sd">    :param zcoords: The 3rd dimension or &#39;z&#39; coordinates at cell centers, as a Python list or numpy Array</span>
<span class="sd">    :param xcorners: The 1st dimension or &#39;x&#39; coordinates at cell corners, as a Python list or numpy Array</span>
<span class="sd">    :param ycorners: The 2nd dimension or &#39;y&#39; coordinates at cell corners, as a Python list or numpy Array</span>
<span class="sd">    :param zcorners: The 3rd dimension or &#39;z&#39; coordinates at cell corners, as a Python list or numpy Array</span>
<span class="sd">    :param corners: boolean to determine whether or not to add corner coordinates to this grid</span>
<span class="sd">    :param domask: boolean to determine whether to set an arbitrary mask or not</span>
<span class="sd">    :param doarea: boolean to determine whether to set an arbitrary area values or not</span>
<span class="sd">    :return: grid</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="p">[</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span>

    <span class="c1"># create a grid given the number of grid cells in each dimension, the center stagger location is allocated and the</span>
    <span class="c1"># Cartesian coordinate system is specified</span>
    <span class="n">max_index</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="nb">len</span><span class="p">(</span><span class="n">xcoords</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">ycoords</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">zcoords</span><span class="p">)])</span>
    <span class="n">grid</span> <span class="o">=</span> <span class="n">ESMF</span><span class="o">.</span><span class="n">Grid</span><span class="p">(</span><span class="n">max_index</span><span class="p">,</span> <span class="n">staggerloc</span><span class="o">=</span><span class="p">[</span><span class="n">ESMF</span><span class="o">.</span><span class="n">StaggerLoc</span><span class="o">.</span><span class="n">CENTER_VCENTER</span><span class="p">],</span> <span class="n">coord_sys</span><span class="o">=</span><span class="n">ESMF</span><span class="o">.</span><span class="n">CoordSys</span><span class="o">.</span><span class="n">CART</span><span class="p">)</span>

    <span class="c1"># set the grid coordinates using numpy arrays, parallel case is handled using grid bounds</span>
    <span class="n">gridXCenter</span> <span class="o">=</span> <span class="n">grid</span><span class="o">.</span><span class="n">get_coords</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="n">x_par</span> <span class="o">=</span> <span class="n">xcoords</span><span class="p">[</span><span class="n">grid</span><span class="o">.</span><span class="n">lower_bounds</span><span class="p">[</span><span class="n">ESMF</span><span class="o">.</span><span class="n">StaggerLoc</span><span class="o">.</span><span class="n">CENTER_VCENTER</span><span class="p">][</span><span class="n">x</span><span class="p">]:</span><span class="n">grid</span><span class="o">.</span><span class="n">upper_bounds</span><span class="p">[</span><span class="n">ESMF</span><span class="o">.</span><span class="n">StaggerLoc</span><span class="o">.</span><span class="n">CENTER_VCENTER</span><span class="p">][</span><span class="n">x</span><span class="p">]]</span>
    <span class="n">gridXCenter</span><span class="p">[</span><span class="o">...</span><span class="p">]</span> <span class="o">=</span> <span class="n">x_par</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">x_par</span><span class="o">.</span><span class="n">size</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

    <span class="n">gridYCenter</span> <span class="o">=</span> <span class="n">grid</span><span class="o">.</span><span class="n">get_coords</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
    <span class="n">y_par</span> <span class="o">=</span> <span class="n">ycoords</span><span class="p">[</span><span class="n">grid</span><span class="o">.</span><span class="n">lower_bounds</span><span class="p">[</span><span class="n">ESMF</span><span class="o">.</span><span class="n">StaggerLoc</span><span class="o">.</span><span class="n">CENTER_VCENTER</span><span class="p">][</span><span class="n">y</span><span class="p">]:</span><span class="n">grid</span><span class="o">.</span><span class="n">upper_bounds</span><span class="p">[</span><span class="n">ESMF</span><span class="o">.</span><span class="n">StaggerLoc</span><span class="o">.</span><span class="n">CENTER_VCENTER</span><span class="p">][</span><span class="n">y</span><span class="p">]]</span>
    <span class="n">gridYCenter</span><span class="p">[</span><span class="o">...</span><span class="p">]</span> <span class="o">=</span> <span class="n">y_par</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">y_par</span><span class="o">.</span><span class="n">size</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

    <span class="n">gridZCenter</span> <span class="o">=</span> <span class="n">grid</span><span class="o">.</span><span class="n">get_coords</span><span class="p">(</span><span class="n">z</span><span class="p">)</span>
    <span class="n">z_par</span> <span class="o">=</span> <span class="n">zcoords</span><span class="p">[</span><span class="n">grid</span><span class="o">.</span><span class="n">lower_bounds</span><span class="p">[</span><span class="n">ESMF</span><span class="o">.</span><span class="n">StaggerLoc</span><span class="o">.</span><span class="n">CENTER_VCENTER</span><span class="p">][</span><span class="n">z</span><span class="p">]:</span><span class="n">grid</span><span class="o">.</span><span class="n">upper_bounds</span><span class="p">[</span><span class="n">ESMF</span><span class="o">.</span><span class="n">StaggerLoc</span><span class="o">.</span><span class="n">CENTER_VCENTER</span><span class="p">][</span><span class="n">z</span><span class="p">]]</span>
    <span class="n">gridZCenter</span><span class="p">[</span><span class="o">...</span><span class="p">]</span> <span class="o">=</span> <span class="n">z_par</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">z_par</span><span class="o">.</span><span class="n">size</span><span class="p">)</span>

    <span class="c1"># create grid corners in a slightly different manner to account for the bounds format common in CF-like files</span>
    <span class="k">if</span> <span class="n">corners</span><span class="p">:</span>
        <span class="n">grid</span><span class="o">.</span><span class="n">add_coords</span><span class="p">([</span><span class="n">ESMF</span><span class="o">.</span><span class="n">StaggerLoc</span><span class="o">.</span><span class="n">CORNER_VFACE</span><span class="p">])</span>
        <span class="n">lbx</span> <span class="o">=</span> <span class="n">grid</span><span class="o">.</span><span class="n">lower_bounds</span><span class="p">[</span><span class="n">ESMF</span><span class="o">.</span><span class="n">StaggerLoc</span><span class="o">.</span><span class="n">CORNER_VFACE</span><span class="p">][</span><span class="n">x</span><span class="p">]</span>
        <span class="n">ubx</span> <span class="o">=</span> <span class="n">grid</span><span class="o">.</span><span class="n">upper_bounds</span><span class="p">[</span><span class="n">ESMF</span><span class="o">.</span><span class="n">StaggerLoc</span><span class="o">.</span><span class="n">CORNER_VFACE</span><span class="p">][</span><span class="n">x</span><span class="p">]</span>
        <span class="n">lby</span> <span class="o">=</span> <span class="n">grid</span><span class="o">.</span><span class="n">lower_bounds</span><span class="p">[</span><span class="n">ESMF</span><span class="o">.</span><span class="n">StaggerLoc</span><span class="o">.</span><span class="n">CORNER_VFACE</span><span class="p">][</span><span class="n">y</span><span class="p">]</span>
        <span class="n">uby</span> <span class="o">=</span> <span class="n">grid</span><span class="o">.</span><span class="n">upper_bounds</span><span class="p">[</span><span class="n">ESMF</span><span class="o">.</span><span class="n">StaggerLoc</span><span class="o">.</span><span class="n">CORNER_VFACE</span><span class="p">][</span><span class="n">y</span><span class="p">]</span>
        <span class="n">lbz</span> <span class="o">=</span> <span class="n">grid</span><span class="o">.</span><span class="n">lower_bounds</span><span class="p">[</span><span class="n">ESMF</span><span class="o">.</span><span class="n">StaggerLoc</span><span class="o">.</span><span class="n">CORNER_VFACE</span><span class="p">][</span><span class="n">z</span><span class="p">]</span>
        <span class="n">ubz</span> <span class="o">=</span> <span class="n">grid</span><span class="o">.</span><span class="n">upper_bounds</span><span class="p">[</span><span class="n">ESMF</span><span class="o">.</span><span class="n">StaggerLoc</span><span class="o">.</span><span class="n">CORNER_VFACE</span><span class="p">][</span><span class="n">z</span><span class="p">]</span>

        <span class="n">gridXCorner</span> <span class="o">=</span> <span class="n">grid</span><span class="o">.</span><span class="n">get_coords</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">staggerloc</span><span class="o">=</span><span class="n">ESMF</span><span class="o">.</span><span class="n">StaggerLoc</span><span class="o">.</span><span class="n">CORNER_VFACE</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i0</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ubx</span> <span class="o">-</span> <span class="n">lbx</span> <span class="o">-</span> <span class="mi">1</span><span class="p">):</span>
            <span class="n">gridXCorner</span><span class="p">[</span><span class="n">i0</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">xcorners</span><span class="p">[</span><span class="n">i0</span><span class="o">+</span><span class="n">lbx</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
        <span class="n">gridXCorner</span><span class="p">[</span><span class="n">i0</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">xcorners</span><span class="p">[</span><span class="n">i0</span><span class="o">+</span><span class="n">lbx</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>

        <span class="n">gridYCorner</span> <span class="o">=</span> <span class="n">grid</span><span class="o">.</span><span class="n">get_coords</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">staggerloc</span><span class="o">=</span><span class="n">ESMF</span><span class="o">.</span><span class="n">StaggerLoc</span><span class="o">.</span><span class="n">CORNER_VFACE</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i1</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">uby</span> <span class="o">-</span> <span class="n">lby</span> <span class="o">-</span> <span class="mi">1</span><span class="p">):</span>
            <span class="n">gridYCorner</span><span class="p">[:,</span> <span class="n">i1</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">ycorners</span><span class="p">[</span><span class="n">i1</span><span class="o">+</span><span class="n">lby</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
        <span class="n">gridYCorner</span><span class="p">[:,</span> <span class="n">i1</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">ycorners</span><span class="p">[</span><span class="n">i1</span><span class="o">+</span><span class="n">lby</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>

        <span class="n">gridZCorner</span> <span class="o">=</span> <span class="n">grid</span><span class="o">.</span><span class="n">get_coords</span><span class="p">(</span><span class="n">z</span><span class="p">,</span> <span class="n">staggerloc</span><span class="o">=</span><span class="n">ESMF</span><span class="o">.</span><span class="n">StaggerLoc</span><span class="o">.</span><span class="n">CORNER_VFACE</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i2</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ubz</span> <span class="o">-</span> <span class="n">lbz</span> <span class="o">-</span> <span class="mi">1</span><span class="p">):</span>
            <span class="n">gridZCorner</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">i2</span><span class="p">]</span> <span class="o">=</span> <span class="n">zcorners</span><span class="p">[</span><span class="n">i2</span><span class="o">+</span><span class="n">lbz</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
        <span class="n">gridZCorner</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">i2</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">zcorners</span><span class="p">[</span><span class="n">i2</span><span class="o">+</span><span class="n">lbz</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>

    <span class="c1"># add an arbitrary mask</span>
    <span class="k">if</span> <span class="n">domask</span><span class="p">:</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="n">grid</span><span class="o">.</span><span class="n">add_item</span><span class="p">(</span><span class="n">ESMF</span><span class="o">.</span><span class="n">GridItem</span><span class="o">.</span><span class="n">MASK</span><span class="p">)</span>
        <span class="n">mask</span><span class="p">[:]</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">mask</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">((</span><span class="mf">1.75</span> <span class="o">&lt;</span> <span class="n">gridXCenter</span><span class="o">.</span><span class="n">data</span> <span class="o">&lt;</span> <span class="mf">2.25</span><span class="p">)</span> <span class="o">&amp;</span>
                      <span class="p">(</span><span class="mf">1.75</span> <span class="o">&lt;</span> <span class="n">gridYCenter</span><span class="o">.</span><span class="n">data</span> <span class="o">&lt;</span> <span class="mf">2.25</span><span class="p">)</span> <span class="o">&amp;</span>
                      <span class="p">(</span><span class="mf">1.75</span> <span class="o">&lt;</span> <span class="n">gridZCenter</span><span class="o">.</span><span class="n">data</span> <span class="o">&lt;</span> <span class="mf">2.25</span><span class="p">))]</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="c1"># add arbitrary areas values</span>
    <span class="k">if</span> <span class="n">doarea</span><span class="p">:</span>
        <span class="n">area</span> <span class="o">=</span> <span class="n">grid</span><span class="o">.</span><span class="n">add_item</span><span class="p">(</span><span class="n">ESMF</span><span class="o">.</span><span class="n">GridItem</span><span class="o">.</span><span class="n">AREA</span><span class="p">)</span>
        <span class="n">area</span><span class="p">[:]</span> <span class="o">=</span> <span class="mf">5.0</span>

    <span class="k">return</span> <span class="n">grid</span>
</pre></div>
</div>
</div></blockquote>
</div>
<div class="section" id="create-a-periodic-grid">
<h3>Create a Periodic Grid<a class="headerlink" href="#create-a-periodic-grid" title="Permalink to this headline">¶</a></h3>
<blockquote>
<div><div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">grid_create_from_coordinates_periodic</span><span class="p">(</span><span class="n">longitudes</span><span class="p">,</span> <span class="n">latitudes</span><span class="p">,</span> <span class="n">lon_corners</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">lat_corners</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">corners</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">domask</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Create a 2 dimensional periodic Grid using the &#39;longitudes&#39; and &#39;latitudes&#39;.</span>
<span class="sd">    :param longitudes: longitude coordinate values at cell centers</span>
<span class="sd">    :param latitudes: latitude coordinate values at cell centers</span>
<span class="sd">    :param lon_corners: longitude coordinate values at cell corners</span>
<span class="sd">    :param lat_corners: latitude coordinate values at cell corners</span>
<span class="sd">    :param corners: boolean to determine whether or not to add corner coordinates to this grid</span>
<span class="sd">    :param domask: boolean to determine whether to set an arbitrary mask or not</span>
<span class="sd">    :return: grid</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="p">[</span><span class="n">lon</span><span class="p">,</span> <span class="n">lat</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>

    <span class="c1"># create a grid given the number of grid cells in each dimension the center stagger location is allocated</span>
    <span class="n">max_index</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="nb">len</span><span class="p">(</span><span class="n">longitudes</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">latitudes</span><span class="p">)])</span>
    <span class="n">grid</span> <span class="o">=</span> <span class="n">ESMF</span><span class="o">.</span><span class="n">Grid</span><span class="p">(</span><span class="n">max_index</span><span class="p">,</span> <span class="n">num_peri_dims</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">staggerloc</span><span class="o">=</span><span class="p">[</span><span class="n">ESMF</span><span class="o">.</span><span class="n">StaggerLoc</span><span class="o">.</span><span class="n">CENTER</span><span class="p">])</span>

    <span class="c1"># set the grid coordinates using numpy arrays, parallel case is handled using grid bounds</span>
    <span class="n">gridXCenter</span> <span class="o">=</span> <span class="n">grid</span><span class="o">.</span><span class="n">get_coords</span><span class="p">(</span><span class="n">lon</span><span class="p">)</span>
    <span class="n">lon_par</span> <span class="o">=</span> <span class="n">longitudes</span><span class="p">[</span><span class="n">grid</span><span class="o">.</span><span class="n">lower_bounds</span><span class="p">[</span><span class="n">ESMF</span><span class="o">.</span><span class="n">StaggerLoc</span><span class="o">.</span><span class="n">CENTER</span><span class="p">][</span><span class="n">lon</span><span class="p">]:</span><span class="n">grid</span><span class="o">.</span><span class="n">upper_bounds</span><span class="p">[</span><span class="n">ESMF</span><span class="o">.</span><span class="n">StaggerLoc</span><span class="o">.</span><span class="n">CENTER</span><span class="p">][</span><span class="n">lon</span><span class="p">]]</span>
    <span class="n">gridXCenter</span><span class="p">[</span><span class="o">...</span><span class="p">]</span> <span class="o">=</span> <span class="n">lon_par</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">lon_par</span><span class="o">.</span><span class="n">size</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>

    <span class="n">gridYCenter</span> <span class="o">=</span> <span class="n">grid</span><span class="o">.</span><span class="n">get_coords</span><span class="p">(</span><span class="n">lat</span><span class="p">)</span>
    <span class="n">lat_par</span> <span class="o">=</span> <span class="n">latitudes</span><span class="p">[</span><span class="n">grid</span><span class="o">.</span><span class="n">lower_bounds</span><span class="p">[</span><span class="n">ESMF</span><span class="o">.</span><span class="n">StaggerLoc</span><span class="o">.</span><span class="n">CENTER</span><span class="p">][</span><span class="n">lat</span><span class="p">]:</span><span class="n">grid</span><span class="o">.</span><span class="n">upper_bounds</span><span class="p">[</span><span class="n">ESMF</span><span class="o">.</span><span class="n">StaggerLoc</span><span class="o">.</span><span class="n">CENTER</span><span class="p">][</span><span class="n">lat</span><span class="p">]]</span>
    <span class="n">gridYCenter</span><span class="p">[</span><span class="o">...</span><span class="p">]</span> <span class="o">=</span> <span class="n">lat_par</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span> <span class="n">lat_par</span><span class="o">.</span><span class="n">size</span><span class="p">))</span>

    <span class="c1"># create grid corners in a slightly different manner to account for the bounds format common in CF-like files</span>
    <span class="k">if</span> <span class="n">corners</span><span class="p">:</span>
        <span class="n">grid</span><span class="o">.</span><span class="n">add_coords</span><span class="p">([</span><span class="n">ESMF</span><span class="o">.</span><span class="n">StaggerLoc</span><span class="o">.</span><span class="n">CORNER</span><span class="p">])</span>
        <span class="n">lbx</span> <span class="o">=</span> <span class="n">grid</span><span class="o">.</span><span class="n">lower_bounds</span><span class="p">[</span><span class="n">ESMF</span><span class="o">.</span><span class="n">StaggerLoc</span><span class="o">.</span><span class="n">CORNER</span><span class="p">][</span><span class="n">lon</span><span class="p">]</span>
        <span class="n">ubx</span> <span class="o">=</span> <span class="n">grid</span><span class="o">.</span><span class="n">upper_bounds</span><span class="p">[</span><span class="n">ESMF</span><span class="o">.</span><span class="n">StaggerLoc</span><span class="o">.</span><span class="n">CORNER</span><span class="p">][</span><span class="n">lon</span><span class="p">]</span>
        <span class="n">lby</span> <span class="o">=</span> <span class="n">grid</span><span class="o">.</span><span class="n">lower_bounds</span><span class="p">[</span><span class="n">ESMF</span><span class="o">.</span><span class="n">StaggerLoc</span><span class="o">.</span><span class="n">CORNER</span><span class="p">][</span><span class="n">lat</span><span class="p">]</span>
        <span class="n">uby</span> <span class="o">=</span> <span class="n">grid</span><span class="o">.</span><span class="n">upper_bounds</span><span class="p">[</span><span class="n">ESMF</span><span class="o">.</span><span class="n">StaggerLoc</span><span class="o">.</span><span class="n">CORNER</span><span class="p">][</span><span class="n">lat</span><span class="p">]</span>

        <span class="n">gridXCorner</span> <span class="o">=</span> <span class="n">grid</span><span class="o">.</span><span class="n">get_coords</span><span class="p">(</span><span class="n">lon</span><span class="p">,</span> <span class="n">staggerloc</span><span class="o">=</span><span class="n">ESMF</span><span class="o">.</span><span class="n">StaggerLoc</span><span class="o">.</span><span class="n">CORNER</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i0</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ubx</span> <span class="o">-</span> <span class="n">lbx</span> <span class="o">-</span> <span class="mi">1</span><span class="p">):</span>
            <span class="n">gridXCorner</span><span class="p">[</span><span class="n">i0</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">lon_corners</span><span class="p">[</span><span class="n">i0</span><span class="o">+</span><span class="n">lbx</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
        <span class="n">gridXCorner</span><span class="p">[</span><span class="n">i0</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">lon_corners</span><span class="p">[</span><span class="n">i0</span><span class="o">+</span><span class="n">lbx</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>

        <span class="n">gridYCorner</span> <span class="o">=</span> <span class="n">grid</span><span class="o">.</span><span class="n">get_coords</span><span class="p">(</span><span class="n">lat</span><span class="p">,</span> <span class="n">staggerloc</span><span class="o">=</span><span class="n">ESMF</span><span class="o">.</span><span class="n">StaggerLoc</span><span class="o">.</span><span class="n">CORNER</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i1</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">uby</span> <span class="o">-</span> <span class="n">lby</span> <span class="o">-</span> <span class="mi">1</span><span class="p">):</span>
            <span class="n">gridYCorner</span><span class="p">[:,</span> <span class="n">i1</span><span class="p">]</span> <span class="o">=</span> <span class="n">lat_corners</span><span class="p">[</span><span class="n">i1</span><span class="o">+</span><span class="n">lby</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
        <span class="n">gridYCorner</span><span class="p">[:,</span> <span class="n">i1</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">lat_corners</span><span class="p">[</span><span class="n">i1</span><span class="o">+</span><span class="n">lby</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>

    <span class="c1"># add an arbitrary mask</span>
    <span class="k">if</span> <span class="n">domask</span><span class="p">:</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="n">grid</span><span class="o">.</span><span class="n">add_item</span><span class="p">(</span><span class="n">ESMF</span><span class="o">.</span><span class="n">GridItem</span><span class="o">.</span><span class="n">MASK</span><span class="p">)</span>
        <span class="n">mask</span><span class="p">[:]</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">mask</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">((</span><span class="mf">1.75</span> <span class="o">&lt;=</span> <span class="n">gridXCenter</span><span class="o">.</span><span class="n">any</span><span class="p">()</span> <span class="o">&lt;</span> <span class="mf">2.25</span><span class="p">)</span> <span class="o">&amp;</span>
                      <span class="p">(</span><span class="mf">1.75</span> <span class="o">&lt;=</span> <span class="n">gridYCenter</span><span class="o">.</span><span class="n">any</span><span class="p">()</span> <span class="o">&lt;</span> <span class="mf">2.25</span><span class="p">))]</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">return</span> <span class="n">grid</span>
</pre></div>
</div>
</div></blockquote>
</div>
<div class="section" id="create-a-5-element-mesh">
<h3>Create a 5 Element Mesh<a class="headerlink" href="#create-a-5-element-mesh" title="Permalink to this headline">¶</a></h3>
<blockquote>
<div><div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">mesh_create_5</span><span class="p">():</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    PRECONDITIONS: None</span>
<span class="sd">    POSTCONDITIONS: A 5 element Mesh has been created.    </span>
<span class="sd">    RETURN VALUES: \n Mesh :: mesh \n</span>
<span class="sd">    </span>
<span class="sd">      4.0   31 ------ 32 ------ 33</span>
<span class="sd">            |         |  22  /   |</span>
<span class="sd">            |    21   |     /    |</span>
<span class="sd">            |         |   /  23  |</span>
<span class="sd">      2.0   21 ------ 22 ------ 23</span>
<span class="sd">            |         |          |</span>
<span class="sd">            |    11   |    12    |</span>
<span class="sd">            |         |          |</span>
<span class="sd">      0.0   11 ------ 12 ------ 13</span>
<span class="sd">    </span>
<span class="sd">           0.0       2.0        4.0</span>
<span class="sd">    </span>
<span class="sd">          Node Ids at corners</span>
<span class="sd">          Element Ids in centers</span>
<span class="sd">    </span>
<span class="sd">    Note: This mesh is not parallel, it can only be used in serial</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="c1"># Two parametric dimensions, and two spatial dimensions</span>
    <span class="n">mesh</span> <span class="o">=</span> <span class="n">ESMF</span><span class="o">.</span><span class="n">Mesh</span><span class="p">(</span><span class="n">parametric_dim</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">spatial_dim</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
    
    <span class="n">num_node</span> <span class="o">=</span> <span class="mi">9</span>
    <span class="n">num_elem</span> <span class="o">=</span> <span class="mi">5</span>
    <span class="n">nodeId</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">11</span><span class="p">,</span><span class="mi">12</span><span class="p">,</span><span class="mi">13</span><span class="p">,</span><span class="mi">21</span><span class="p">,</span><span class="mi">22</span><span class="p">,</span><span class="mi">23</span><span class="p">,</span><span class="mi">31</span><span class="p">,</span><span class="mi">32</span><span class="p">,</span><span class="mi">33</span><span class="p">])</span>
    <span class="n">nodeCoord</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.0</span><span class="p">,</span><span class="mf">0.0</span><span class="p">,</span>  <span class="c1"># node 11</span>
                          <span class="mf">2.0</span><span class="p">,</span><span class="mf">0.0</span><span class="p">,</span>  <span class="c1"># node 12</span>
                          <span class="mf">4.0</span><span class="p">,</span><span class="mf">0.0</span><span class="p">,</span>  <span class="c1"># node 13</span>
                          <span class="mf">0.0</span><span class="p">,</span><span class="mf">2.0</span><span class="p">,</span>  <span class="c1"># node 21</span>
                          <span class="mf">2.0</span><span class="p">,</span><span class="mf">2.0</span><span class="p">,</span>  <span class="c1"># node 22</span>
                          <span class="mf">4.0</span><span class="p">,</span><span class="mf">2.0</span><span class="p">,</span>  <span class="c1"># node 23</span>
                          <span class="mf">0.0</span><span class="p">,</span><span class="mf">4.0</span><span class="p">,</span>  <span class="c1"># node 31</span>
                          <span class="mf">2.0</span><span class="p">,</span><span class="mf">4.0</span><span class="p">,</span>  <span class="c1"># node 32</span>
                          <span class="mf">4.0</span><span class="p">,</span><span class="mf">4.0</span><span class="p">])</span> <span class="c1"># node 33</span>
    <span class="n">nodeOwner</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">num_node</span><span class="p">)</span>

    <span class="n">elemId</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">11</span><span class="p">,</span><span class="mi">12</span><span class="p">,</span><span class="mi">21</span><span class="p">,</span><span class="mi">22</span><span class="p">,</span><span class="mi">23</span><span class="p">])</span>
    <span class="n">elemType</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">ESMF</span><span class="o">.</span><span class="n">MeshElemType</span><span class="o">.</span><span class="n">QUAD</span><span class="p">,</span>
                       <span class="n">ESMF</span><span class="o">.</span><span class="n">MeshElemType</span><span class="o">.</span><span class="n">QUAD</span><span class="p">,</span>
                       <span class="n">ESMF</span><span class="o">.</span><span class="n">MeshElemType</span><span class="o">.</span><span class="n">QUAD</span><span class="p">,</span>
                       <span class="n">ESMF</span><span class="o">.</span><span class="n">MeshElemType</span><span class="o">.</span><span class="n">TRI</span><span class="p">,</span>
                       <span class="n">ESMF</span><span class="o">.</span><span class="n">MeshElemType</span><span class="o">.</span><span class="n">TRI</span><span class="p">])</span>
    <span class="n">elemConn</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span> <span class="c1"># element 11</span>
                       <span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span> <span class="c1"># element 12</span>
                       <span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">7</span><span class="p">,</span><span class="mi">6</span><span class="p">,</span> <span class="c1"># element 21</span>
                       <span class="mi">4</span><span class="p">,</span><span class="mi">8</span><span class="p">,</span><span class="mi">7</span><span class="p">,</span>   <span class="c1"># element 22</span>
                       <span class="mi">4</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">8</span><span class="p">])</span>  <span class="c1"># element 23</span>
    <span class="n">elemCoord</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span>
                          <span class="mf">3.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span>
                          <span class="mf">1.0</span><span class="p">,</span> <span class="mf">3.0</span><span class="p">,</span>
                          <span class="mf">2.5</span><span class="p">,</span> <span class="mf">3.5</span><span class="p">,</span>
                          <span class="mf">3.5</span><span class="p">,</span> <span class="mf">2.5</span><span class="p">])</span>

    <span class="n">mesh</span><span class="o">.</span><span class="n">add_nodes</span><span class="p">(</span><span class="n">num_node</span><span class="p">,</span><span class="n">nodeId</span><span class="p">,</span><span class="n">nodeCoord</span><span class="p">,</span><span class="n">nodeOwner</span><span class="p">)</span>

    <span class="n">mesh</span><span class="o">.</span><span class="n">add_elements</span><span class="p">(</span><span class="n">num_elem</span><span class="p">,</span><span class="n">elemId</span><span class="p">,</span><span class="n">elemType</span><span class="p">,</span><span class="n">elemConn</span><span class="p">,</span> <span class="n">element_coords</span><span class="o">=</span><span class="n">elemCoord</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">mesh</span><span class="p">,</span> <span class="n">nodeCoord</span><span class="p">,</span> <span class="n">nodeOwner</span><span class="p">,</span> <span class="n">elemType</span><span class="p">,</span> <span class="n">elemConn</span><span class="p">,</span> <span class="n">elemCoord</span>
</pre></div>
</div>
</div></blockquote>
</div>
<div class="section" id="create-a-field">
<h3>Create a Field<a class="headerlink" href="#create-a-field" title="Permalink to this headline">¶</a></h3>
<blockquote>
<div><div class="highlight-default notranslate"><div class="highlight"><pre><span></span>    <span class="k">def</span> <span class="nf">create_field</span><span class="p">(</span><span class="n">gml</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        PRECONDITIONS: An Grid, Mesh or LocStream has been created, and &#39;name&#39; is a string that</span>
<span class="sd">                       will be used to initialize the name of a new Field.\n</span>
<span class="sd">        POSTCONDITIONS: A Field has been created.\n</span>
<span class="sd">        RETURN VALUES: \n Field :: field \n</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">field</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">gml</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">field</span>
</pre></div>
</div>
</div></blockquote>
</div>
<div class="section" id="initialize-an-analytic-field">
<h3>Initialize an Analytic Field<a class="headerlink" href="#initialize-an-analytic-field" title="Permalink to this headline">¶</a></h3>
<blockquote>
<div><div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">initialize_field_grid_periodic</span><span class="p">(</span><span class="n">field</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    PRECONDITIONS: A Field has been created as &#39;field&#39; with a &#39;grid&#39;</span>
<span class="sd">                   where coordinates have been set on both </span>
<span class="sd">                   the center and corner stagger locations. \n</span>
<span class="sd">    POSTCONDITIONS: The &#39;field&#39; has been initialized to an analytic </span>
<span class="sd">                    field.\n</span>
<span class="sd">    RETURN VALUES: \n Field :: field \n</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">DEG2RAD</span> <span class="o">=</span> <span class="mf">3.141592653589793</span><span class="o">/</span><span class="mf">180.0</span>

    <span class="c1"># get the coordinate pointers and set the coordinates</span>
    <span class="p">[</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>
    <span class="n">gridXCoord</span> <span class="o">=</span> <span class="n">field</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">get_coords</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">ESMF</span><span class="o">.</span><span class="n">StaggerLoc</span><span class="o">.</span><span class="n">CENTER</span><span class="p">)</span>
    <span class="n">gridYCoord</span> <span class="o">=</span> <span class="n">field</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">get_coords</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">ESMF</span><span class="o">.</span><span class="n">StaggerLoc</span><span class="o">.</span><span class="n">CENTER</span><span class="p">)</span>

    <span class="n">field</span><span class="o">.</span><span class="n">data</span><span class="p">[:]</span> <span class="o">=</span> <span class="mf">2.0</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">DEG2RAD</span><span class="o">*</span><span class="n">gridXCoord</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> \
                          <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="mf">2.0</span><span class="o">*</span><span class="n">DEG2RAD</span><span class="o">*</span><span class="p">(</span><span class="mf">90.0</span> <span class="o">-</span> <span class="n">gridYCoord</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">field</span>
</pre></div>
</div>
</div></blockquote>
</div>
<div class="section" id="run-esmpy-regridding">
<h3>Run ESMPy Regridding<a class="headerlink" href="#run-esmpy-regridding" title="Permalink to this headline">¶</a></h3>
<blockquote>
<div><div class="highlight-default notranslate"><div class="highlight"><pre><span></span>    <span class="k">def</span> <span class="nf">run_regridding</span><span class="p">(</span><span class="n">srcfield</span><span class="p">,</span> <span class="n">dstfield</span><span class="p">,</span> <span class="n">srcfracfield</span><span class="p">,</span> <span class="n">dstfracfield</span><span class="p">):</span>
        <span class="c1"># This is for documentation. Do not modify.</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        PRECONDITIONS: Two Fields have been created and a regridding</span>
<span class="sd">                       operation is desired from &#39;srcfield&#39; to &#39;dstfield&#39;.</span>
<span class="sd">                       The &#39;srcfracfield&#39; and &#39;dstfractfield&#39; are Fields</span>
<span class="sd">                       created to hold the fractions of the source and</span>
<span class="sd">                       destination fields which contribute to conservative</span>
<span class="sd">                       regridding.\n</span>
<span class="sd">        POSTCONDITIONS: A regridding operation has set the data on</span>
<span class="sd">                        &#39;dstfield&#39;, &#39;srcfracfield&#39;, and &#39;dstfracfield&#39;.\n</span>
<span class="sd">        RETURN VALUES: \n Field :: dstfield \n</span>
<span class="sd">                          Field :: srcfracfield \n</span>
<span class="sd">                          Field :: dstfracfield \n</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="c1"># call the regridding functions</span>
        <span class="n">regridSrc2Dst</span> <span class="o">=</span> <span class="n">ESMF</span><span class="o">.</span><span class="n">Regrid</span><span class="p">(</span><span class="n">srcfield</span><span class="p">,</span> <span class="n">dstfield</span><span class="p">,</span>
                                    <span class="n">regrid_method</span><span class="o">=</span><span class="n">ESMF</span><span class="o">.</span><span class="n">RegridMethod</span><span class="o">.</span><span class="n">CONSERVE</span><span class="p">,</span>
                                    <span class="n">unmapped_action</span><span class="o">=</span><span class="n">ESMF</span><span class="o">.</span><span class="n">UnmappedAction</span><span class="o">.</span><span class="n">ERROR</span><span class="p">,</span>
                                    <span class="n">src_frac_field</span><span class="o">=</span><span class="n">srcfracfield</span><span class="p">,</span>
                                    <span class="n">dst_frac_field</span><span class="o">=</span><span class="n">dstfracfield</span><span class="p">)</span>
        <span class="n">dstfield</span> <span class="o">=</span> <span class="n">regridSrc2Dst</span><span class="p">(</span><span class="n">srcfield</span><span class="p">,</span> <span class="n">dstfield</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">dstfield</span><span class="p">,</span> <span class="n">srcfracfield</span><span class="p">,</span> <span class="n">dstfracfield</span>
</pre></div>
</div>
</div></blockquote>
</div>
<div class="section" id="compute-field-mass">
<h3>Compute Field Mass<a class="headerlink" href="#compute-field-mass" title="Permalink to this headline">¶</a></h3>
<blockquote>
<div><div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">compute_mass_grid</span><span class="p">(</span><span class="n">valuefield</span><span class="p">,</span> <span class="n">dofrac</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">fracfield</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                      <span class="n">uninitval</span><span class="o">=</span><span class="mf">422397696.</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    PRECONDITIONS: &#39;fracfield&#39; contains the fractions of each cell</span>
<span class="sd">                   which contributed to a regridding operation involving</span>
<span class="sd">                   &#39;valuefield.  &#39;dofrac&#39; is a boolean value that gives </span>
<span class="sd">                   the option to not use the &#39;fracfield&#39;.\n</span>
<span class="sd">    POSTCONDITIONS: The mass of the data field is computed.\n</span>
<span class="sd">    RETURN VALUES: float :: mass \n</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">mass</span> <span class="o">=</span> <span class="mf">0.0</span>
    <span class="n">areafield</span> <span class="o">=</span> <span class="n">ESMF</span><span class="o">.</span><span class="n">Field</span><span class="p">(</span><span class="n">valuefield</span><span class="o">.</span><span class="n">grid</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;areafield&#39;</span><span class="p">)</span>
    <span class="n">areafield</span><span class="o">.</span><span class="n">get_area</span><span class="p">()</span>

    <span class="n">ind</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">valuefield</span><span class="o">.</span><span class="n">data</span> <span class="o">!=</span> <span class="n">uninitval</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">dofrac</span><span class="p">:</span>
        <span class="n">mass</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">areafield</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span> <span class="o">*</span> <span class="n">valuefield</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span> <span class="o">*</span> <span class="n">fracfield</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">ind</span><span class="p">])</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">mass</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">areafield</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span> <span class="o">*</span> <span class="n">valuefield</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">ind</span><span class="p">])</span>

    <span class="k">return</span> <span class="n">mass</span>
</pre></div>
</div>
</div></blockquote>
</div>
</div>
<div class="section" id="regridding">
<h2>Regridding<a class="headerlink" href="#regridding" title="Permalink to this headline">¶</a></h2>
<p>The following stand alone scripts demonstrate how to use regridding between
<a class="reference internal" href="field.html#ESMF.api.field.Field" title="ESMF.api.field.Field"><code class="xref py py-class docutils literal notranslate"><span class="pre">Fields</span></code></a> built on
<a class="reference internal" href="grid.html#ESMF.api.grid.Grid" title="ESMF.api.grid.Grid"><code class="xref py py-class docutils literal notranslate"><span class="pre">Grids</span></code></a>, <a class="reference internal" href="mesh.html#ESMF.api.mesh.Mesh" title="ESMF.api.mesh.Mesh"><code class="xref py py-class docutils literal notranslate"><span class="pre">Meshes</span></code></a>
and <a class="reference internal" href="locstream.html#ESMF.api.locstream.LocStream" title="ESMF.api.locstream.LocStream"><code class="xref py py-class docutils literal notranslate"><span class="pre">LocStreams</span></code></a>. These scripts
can be run in serial or parallel with no modification.</p>
<div class="section" id="grid-mesh-and-field-created-from-file">
<h3>Grid, Mesh and Field Created from File<a class="headerlink" href="#grid-mesh-and-field-created-from-file" title="Permalink to this headline">¶</a></h3>
<blockquote>
<div><div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># This example demonstrates how to create ESMPy Grid, Mesh and Field objects </span>
<span class="c1"># from file and use them for regridding.</span>
<span class="c1"># The data files can be retrieved from the ESMF data repository by uncommenting the</span>
<span class="c1"># following block of code:</span>
<span class="c1">#</span>
<span class="c1"># import os</span>
<span class="c1"># DD = os.path.join(os.getcwd(), &quot;examples/data&quot;)</span>
<span class="c1"># if not os.path.isdir(DD):</span>
<span class="c1">#     os.makedirs(DD)</span>
<span class="c1"># from ESMF.util.cache_data import cache_data_file</span>
<span class="c1"># cache_data_file(os.path.join(DD, &quot;so_Omon_GISS-E2.nc&quot;))</span>
<span class="c1"># cache_data_file(os.path.join(DD, &quot;mpas_uniform_10242_dual_counterclockwise.nc&quot;))</span>

<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">ESMF</span>

<span class="c1"># This call enables debug logging</span>
<span class="c1"># ESMF.Manager(debug=True)</span>

<span class="c1"># Set up the DATADIR</span>
<span class="n">DATADIR</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">(),</span> <span class="s2">&quot;examples/data&quot;</span><span class="p">)</span>

<span class="c1"># Create a  global grid from a GRIDSPEC formatted file</span>
<span class="n">grid</span> <span class="o">=</span> <span class="n">ESMF</span><span class="o">.</span><span class="n">Grid</span><span class="p">(</span><span class="n">filename</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">DATADIR</span><span class="p">,</span> <span class="s2">&quot;so_Omon_GISS-E2.nc&quot;</span><span class="p">),</span>
                 <span class="n">filetype</span><span class="o">=</span><span class="n">ESMF</span><span class="o">.</span><span class="n">FileFormat</span><span class="o">.</span><span class="n">GRIDSPEC</span><span class="p">)</span>

<span class="c1"># Create a field on the centers of the grid, with extra dimensions</span>
<span class="n">srcfield</span> <span class="o">=</span> <span class="n">ESMF</span><span class="o">.</span><span class="n">Field</span><span class="p">(</span><span class="n">grid</span><span class="p">,</span> <span class="n">staggerloc</span><span class="o">=</span><span class="n">ESMF</span><span class="o">.</span><span class="n">StaggerLoc</span><span class="o">.</span><span class="n">CENTER</span><span class="p">,</span> <span class="n">ndbounds</span><span class="o">=</span><span class="p">[</span><span class="mi">33</span><span class="p">,</span> <span class="mi">2</span><span class="p">])</span>

<span class="c1"># Read the field data from file</span>
<span class="n">srcfield</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">filename</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">DATADIR</span><span class="p">,</span> <span class="s2">&quot;so_Omon_GISS-E2.nc&quot;</span><span class="p">),</span>
           <span class="n">variable</span><span class="o">=</span><span class="s2">&quot;so&quot;</span><span class="p">,</span> <span class="n">timeslice</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>

<span class="c1"># Create an ESMF formatted unstructured mesh with clockwise cells removed</span>
<span class="n">mesh</span> <span class="o">=</span> <span class="n">ESMF</span><span class="o">.</span><span class="n">Mesh</span><span class="p">(</span><span class="n">filename</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">DATADIR</span><span class="p">,</span> <span class="s2">&quot;mpas_uniform_10242_dual_counterclockwise.nc&quot;</span><span class="p">),</span>
                 <span class="n">filetype</span><span class="o">=</span><span class="n">ESMF</span><span class="o">.</span><span class="n">FileFormat</span><span class="o">.</span><span class="n">ESMFMESH</span><span class="p">)</span>

<span class="c1"># Create a field on the nodes of the mesh</span>
<span class="n">dstfield</span> <span class="o">=</span> <span class="n">ESMF</span><span class="o">.</span><span class="n">Field</span><span class="p">(</span><span class="n">mesh</span><span class="p">,</span> <span class="n">meshloc</span><span class="o">=</span><span class="n">ESMF</span><span class="o">.</span><span class="n">MeshLoc</span><span class="o">.</span><span class="n">NODE</span><span class="p">,</span> <span class="n">ndbounds</span><span class="o">=</span><span class="p">[</span><span class="mi">33</span><span class="p">,</span> <span class="mi">2</span><span class="p">])</span>

<span class="n">dstfield</span><span class="o">.</span><span class="n">data</span><span class="p">[:]</span> <span class="o">=</span> <span class="mf">1e20</span>

<span class="c1"># compute the weight matrix for regridding</span>
<span class="n">regrid</span> <span class="o">=</span> <span class="n">ESMF</span><span class="o">.</span><span class="n">Regrid</span><span class="p">(</span><span class="n">srcfield</span><span class="p">,</span> <span class="n">dstfield</span><span class="p">,</span>
                     <span class="n">regrid_method</span><span class="o">=</span><span class="n">ESMF</span><span class="o">.</span><span class="n">RegridMethod</span><span class="o">.</span><span class="n">BILINEAR</span><span class="p">,</span>
                     <span class="n">unmapped_action</span><span class="o">=</span><span class="n">ESMF</span><span class="o">.</span><span class="n">UnmappedAction</span><span class="o">.</span><span class="n">IGNORE</span><span class="p">)</span>

<span class="c1"># calculate the regridding from source to destination field</span>
<span class="n">dstfield</span> <span class="o">=</span> <span class="n">regrid</span><span class="p">(</span><span class="n">srcfield</span><span class="p">,</span> <span class="n">dstfield</span><span class="p">)</span>

<span class="k">if</span> <span class="n">ESMF</span><span class="o">.</span><span class="n">local_pet</span><span class="p">()</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
    <span class="nb">print</span> <span class="p">(</span><span class="s2">&quot;Fields created from file regridded successfully :)&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div></blockquote>
</div>
<div class="section" id="read-and-write-a-weight-file">
<h3>Read and Write a Weight File<a class="headerlink" href="#read-and-write-a-weight-file" title="Permalink to this headline">¶</a></h3>
<blockquote>
<div><div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># This example demonstrates how to regrid between a Grid and a Mesh.</span>
<span class="c1"># The data files can be retrieved from the ESMF data repository by uncommenting the</span>
<span class="c1"># following block of code:</span>
<span class="c1">#</span>
<span class="c1"># import os</span>
<span class="c1"># DD = os.path.join(os.getcwd(), &quot;examples/data&quot;)</span>
<span class="c1"># if not os.path.isdir(DD):</span>
<span class="c1">#     os.makedirs(DD)</span>
<span class="c1"># from ESMF.util.cache_data import cache_data_file</span>
<span class="c1"># cache_data_file(os.path.join(DD, &quot;ll2.5deg_grid.nc&quot;))</span>
<span class="c1"># cache_data_file(os.path.join(DD, &quot;mpas_uniform_10242_dual_counterclockwise.nc&quot;))</span>

<span class="kn">import</span> <span class="nn">ESMF</span>
<span class="kn">import</span> <span class="nn">numpy</span>

<span class="kn">import</span> <span class="nn">ESMF.util.helpers</span> <span class="k">as</span> <span class="nn">helpers</span>
<span class="kn">import</span> <span class="nn">ESMF.api.constants</span> <span class="k">as</span> <span class="nn">constants</span>

<span class="c1"># This call enables debug logging</span>
<span class="n">mg</span> <span class="o">=</span> <span class="n">ESMF</span><span class="o">.</span><span class="n">Manager</span><span class="p">(</span><span class="n">debug</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="c1"># ESMPy uses Fortran style dimension ordering (as of November 2017)</span>
<span class="p">[</span><span class="n">lat</span><span class="p">,</span><span class="n">lon</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span>

<span class="c1"># Create the source grid from memory with periodic dimension specified.</span>
<span class="n">lons</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mf">350.1</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>
<span class="n">lats</span>  <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="o">-</span><span class="mi">85</span><span class="p">,</span> <span class="mf">85.1</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>
<span class="n">srcgrid</span> <span class="o">=</span> <span class="n">ESMF</span><span class="o">.</span><span class="n">Grid</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">lons</span><span class="o">.</span><span class="n">size</span><span class="p">,</span> <span class="n">lats</span><span class="o">.</span><span class="n">size</span><span class="p">]),</span>
                    <span class="n">coord_sys</span><span class="o">=</span><span class="n">ESMF</span><span class="o">.</span><span class="n">CoordSys</span><span class="o">.</span><span class="n">SPH_DEG</span><span class="p">,</span>
                    <span class="n">staggerloc</span><span class="o">=</span><span class="n">ESMF</span><span class="o">.</span><span class="n">StaggerLoc</span><span class="o">.</span><span class="n">CENTER</span><span class="p">,</span>
                    <span class="n">num_peri_dims</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">periodic_dim</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">pole_dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

<span class="c1"># Get and set the source grid coordinates.</span>
<span class="n">srcGridCoordLon</span> <span class="o">=</span> <span class="n">srcgrid</span><span class="o">.</span><span class="n">get_coords</span><span class="p">(</span><span class="n">lon</span><span class="p">)</span>
<span class="n">srcGridCoordLat</span> <span class="o">=</span> <span class="n">srcgrid</span><span class="o">.</span><span class="n">get_coords</span><span class="p">(</span><span class="n">lat</span><span class="p">)</span>

<span class="n">slons_par</span> <span class="o">=</span> <span class="n">lons</span><span class="p">[</span><span class="n">srcgrid</span><span class="o">.</span><span class="n">lower_bounds</span><span class="p">[</span><span class="n">ESMF</span><span class="o">.</span><span class="n">StaggerLoc</span><span class="o">.</span><span class="n">CENTER</span><span class="p">][</span><span class="mi">0</span><span class="p">]:</span><span class="n">srcgrid</span><span class="o">.</span><span class="n">upper_bounds</span><span class="p">[</span><span class="n">ESMF</span><span class="o">.</span><span class="n">StaggerLoc</span><span class="o">.</span><span class="n">CENTER</span><span class="p">][</span><span class="mi">0</span><span class="p">]]</span>
<span class="n">slats_par</span> <span class="o">=</span> <span class="n">lats</span><span class="p">[</span><span class="n">srcgrid</span><span class="o">.</span><span class="n">lower_bounds</span><span class="p">[</span><span class="n">ESMF</span><span class="o">.</span><span class="n">StaggerLoc</span><span class="o">.</span><span class="n">CENTER</span><span class="p">][</span><span class="mi">1</span><span class="p">]:</span><span class="n">srcgrid</span><span class="o">.</span><span class="n">upper_bounds</span><span class="p">[</span><span class="n">ESMF</span><span class="o">.</span><span class="n">StaggerLoc</span><span class="o">.</span><span class="n">CENTER</span><span class="p">][</span><span class="mi">1</span><span class="p">]]</span>

<span class="c1"># make sure to use indexing=&#39;ij&#39; as ESMPy backend uses matrix indexing (not Cartesian)</span>
<span class="n">lonm</span><span class="p">,</span> <span class="n">latm</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="n">slons_par</span><span class="p">,</span> <span class="n">slats_par</span><span class="p">,</span> <span class="n">indexing</span><span class="o">=</span><span class="s1">&#39;ij&#39;</span><span class="p">)</span>

<span class="n">srcGridCoordLon</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">lonm</span>
<span class="n">srcGridCoordLat</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">latm</span>

<span class="c1"># Create the dest grid from memory with periodic dimension specified.</span>
<span class="n">lons</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mf">2.5</span><span class="p">,</span> <span class="mf">357.6</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>
<span class="n">lats</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="o">-</span><span class="mf">87.5</span><span class="p">,</span> <span class="mf">87.6</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>
<span class="n">dstgrid</span> <span class="o">=</span> <span class="n">ESMF</span><span class="o">.</span><span class="n">Grid</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">lons</span><span class="o">.</span><span class="n">size</span><span class="p">,</span> <span class="n">lats</span><span class="o">.</span><span class="n">size</span><span class="p">]),</span>
                    <span class="n">coord_sys</span><span class="o">=</span><span class="n">ESMF</span><span class="o">.</span><span class="n">CoordSys</span><span class="o">.</span><span class="n">SPH_DEG</span><span class="p">,</span>
                    <span class="n">staggerloc</span><span class="o">=</span><span class="n">ESMF</span><span class="o">.</span><span class="n">StaggerLoc</span><span class="o">.</span><span class="n">CENTER</span><span class="p">,</span>
                    <span class="n">num_peri_dims</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">periodic_dim</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">pole_dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

<span class="c1"># Get and set the source grid coordinates.</span>
<span class="n">dstGridCoordLat</span> <span class="o">=</span> <span class="n">dstgrid</span><span class="o">.</span><span class="n">get_coords</span><span class="p">(</span><span class="n">lat</span><span class="p">)</span>
<span class="n">dstGridCoordLon</span> <span class="o">=</span> <span class="n">dstgrid</span><span class="o">.</span><span class="n">get_coords</span><span class="p">(</span><span class="n">lon</span><span class="p">)</span>

<span class="n">dlons_par</span> <span class="o">=</span> <span class="n">lons</span><span class="p">[</span><span class="n">dstgrid</span><span class="o">.</span><span class="n">lower_bounds</span><span class="p">[</span><span class="n">ESMF</span><span class="o">.</span><span class="n">StaggerLoc</span><span class="o">.</span><span class="n">CENTER</span><span class="p">][</span><span class="mi">0</span><span class="p">]:</span><span class="n">dstgrid</span><span class="o">.</span><span class="n">upper_bounds</span><span class="p">[</span><span class="n">ESMF</span><span class="o">.</span><span class="n">StaggerLoc</span><span class="o">.</span><span class="n">CENTER</span><span class="p">][</span><span class="mi">0</span><span class="p">]]</span>
<span class="n">dlats_par</span> <span class="o">=</span> <span class="n">lats</span><span class="p">[</span><span class="n">dstgrid</span><span class="o">.</span><span class="n">lower_bounds</span><span class="p">[</span><span class="n">ESMF</span><span class="o">.</span><span class="n">StaggerLoc</span><span class="o">.</span><span class="n">CENTER</span><span class="p">][</span><span class="mi">1</span><span class="p">]:</span><span class="n">dstgrid</span><span class="o">.</span><span class="n">upper_bounds</span><span class="p">[</span><span class="n">ESMF</span><span class="o">.</span><span class="n">StaggerLoc</span><span class="o">.</span><span class="n">CENTER</span><span class="p">][</span><span class="mi">1</span><span class="p">]]</span>

<span class="c1"># make sure to use indexing=&#39;ij&#39; as ESMPy backend uses matrix indexing (not Cartesian)</span>
<span class="n">lonm</span><span class="p">,</span> <span class="n">latm</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="n">dlons_par</span><span class="p">,</span> <span class="n">dlats_par</span><span class="p">,</span> <span class="n">indexing</span><span class="o">=</span><span class="s1">&#39;ij&#39;</span><span class="p">)</span>

<span class="n">dstGridCoordLon</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">lonm</span>
<span class="n">dstGridCoordLat</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">latm</span>

<span class="c1"># Create a field on the centers of the source grid with the mask applied.</span>
<span class="n">srcfield</span> <span class="o">=</span> <span class="n">ESMF</span><span class="o">.</span><span class="n">Field</span><span class="p">(</span><span class="n">srcgrid</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;srcfield&quot;</span><span class="p">,</span> <span class="n">staggerloc</span><span class="o">=</span><span class="n">ESMF</span><span class="o">.</span><span class="n">StaggerLoc</span><span class="o">.</span><span class="n">CENTER</span><span class="p">)</span>

<span class="c1"># Create a field on the centers of the source grid with the mask applied.</span>
<span class="n">dstfield</span> <span class="o">=</span> <span class="n">ESMF</span><span class="o">.</span><span class="n">Field</span><span class="p">(</span><span class="n">dstgrid</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;dstfield&quot;</span><span class="p">,</span> <span class="n">staggerloc</span><span class="o">=</span><span class="n">ESMF</span><span class="o">.</span><span class="n">StaggerLoc</span><span class="o">.</span><span class="n">CENTER</span><span class="p">)</span>
<span class="n">xctfield</span> <span class="o">=</span> <span class="n">ESMF</span><span class="o">.</span><span class="n">Field</span><span class="p">(</span><span class="n">dstgrid</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;xctfield&quot;</span><span class="p">,</span> <span class="n">staggerloc</span><span class="o">=</span><span class="n">ESMF</span><span class="o">.</span><span class="n">StaggerLoc</span><span class="o">.</span><span class="n">CENTER</span><span class="p">)</span>

<span class="n">gridLon</span> <span class="o">=</span> <span class="n">srcfield</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">get_coords</span><span class="p">(</span><span class="n">lon</span><span class="p">,</span> <span class="n">ESMF</span><span class="o">.</span><span class="n">StaggerLoc</span><span class="o">.</span><span class="n">CENTER</span><span class="p">)</span>
<span class="n">gridLat</span> <span class="o">=</span> <span class="n">srcfield</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">get_coords</span><span class="p">(</span><span class="n">lat</span><span class="p">,</span> <span class="n">ESMF</span><span class="o">.</span><span class="n">StaggerLoc</span><span class="o">.</span><span class="n">CENTER</span><span class="p">)</span>

<span class="c1"># wave = lambda x,k:  numpy.sin(x*k*numpy.pi/180.0)</span>
<span class="c1"># srcfield.data[...] = numpy.outer(wave(slons_par,3), wave(slats_par,3)) + 2</span>

<span class="n">srcfield</span><span class="o">.</span><span class="n">data</span><span class="p">[:,:]</span> <span class="o">=</span> <span class="mf">2.0</span> <span class="o">+</span> <span class="n">numpy</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">radians</span><span class="p">(</span><span class="n">srcGridCoordLat</span><span class="p">)[</span><span class="o">...</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> \
                           <span class="n">numpy</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="mf">2.0</span><span class="o">*</span><span class="n">numpy</span><span class="o">.</span><span class="n">radians</span><span class="p">(</span><span class="n">srcGridCoordLon</span><span class="p">)[</span><span class="o">...</span><span class="p">])</span>

<span class="c1"># wave = lambda x,k:  numpy.sin(x*k*numpy.pi/180.0)</span>
<span class="c1"># xctfield.data[...] = numpy.outer(wave(dlons_par,3), wave(dlats_par,3)) + 2</span>

<span class="n">xctfield</span><span class="o">.</span><span class="n">data</span><span class="p">[:,:]</span> <span class="o">=</span> <span class="mf">2.0</span> <span class="o">+</span> <span class="n">numpy</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">radians</span><span class="p">(</span><span class="n">dstGridCoordLat</span><span class="p">)[</span><span class="o">...</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> \
                           <span class="n">numpy</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="mf">2.0</span><span class="o">*</span><span class="n">numpy</span><span class="o">.</span><span class="n">radians</span><span class="p">(</span><span class="n">dstGridCoordLon</span><span class="p">)[</span><span class="o">...</span><span class="p">])</span>

<span class="n">dstfield</span><span class="o">.</span><span class="n">data</span><span class="p">[:]</span> <span class="o">=</span> <span class="mf">1e20</span>

<span class="c1"># write regridding weights to file</span>
<span class="n">filename</span> <span class="o">=</span> <span class="s2">&quot;esmpy_example_weight_file.nc&quot;</span>
<span class="k">if</span> <span class="n">ESMF</span><span class="o">.</span><span class="n">local_pet</span><span class="p">()</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">os</span>
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span>
        <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">(),</span> <span class="n">filename</span><span class="p">)):</span>
        <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">(),</span> <span class="n">filename</span><span class="p">))</span>

<span class="n">mg</span><span class="o">.</span><span class="n">barrier</span><span class="p">()</span>
<span class="n">regrid</span> <span class="o">=</span> <span class="n">ESMF</span><span class="o">.</span><span class="n">Regrid</span><span class="p">(</span><span class="n">srcfield</span><span class="p">,</span> <span class="n">dstfield</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="n">filename</span><span class="p">,</span>
                     <span class="n">regrid_method</span><span class="o">=</span><span class="n">ESMF</span><span class="o">.</span><span class="n">RegridMethod</span><span class="o">.</span><span class="n">BILINEAR</span><span class="p">,</span>
                     <span class="n">unmapped_action</span><span class="o">=</span><span class="n">ESMF</span><span class="o">.</span><span class="n">UnmappedAction</span><span class="o">.</span><span class="n">IGNORE</span><span class="p">)</span>


<span class="c1"># # create a regrid object from file</span>
<span class="n">regrid</span> <span class="o">=</span> <span class="n">ESMF</span><span class="o">.</span><span class="n">RegridFromFile</span><span class="p">(</span><span class="n">srcfield</span><span class="p">,</span> <span class="n">dstfield</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>

<span class="c1"># calculate the regridding from source to destination field</span>
<span class="n">dstfield</span> <span class="o">=</span> <span class="n">regrid</span><span class="p">(</span><span class="n">srcfield</span><span class="p">,</span> <span class="n">dstfield</span><span class="p">)</span>

<span class="c1"># compute the mean relative error</span>
<span class="n">num_nodes</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">prod</span><span class="p">(</span><span class="n">xctfield</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[:])</span>
<span class="n">relerr</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">meanrelerr</span> <span class="o">=</span> <span class="mi">0</span>
<span class="k">if</span> <span class="n">num_nodes</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
    <span class="n">relerr</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">dstfield</span><span class="o">.</span><span class="n">data</span> <span class="o">-</span> <span class="n">xctfield</span><span class="o">.</span><span class="n">data</span><span class="p">)</span> <span class="o">/</span>
                       <span class="n">numpy</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">xctfield</span><span class="o">.</span><span class="n">data</span><span class="p">))</span>
    <span class="n">meanrelerr</span> <span class="o">=</span> <span class="n">relerr</span> <span class="o">/</span> <span class="n">num_nodes</span>

<span class="c1"># handle the parallel case</span>
<span class="k">if</span> <span class="n">ESMF</span><span class="o">.</span><span class="n">pet_count</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
    <span class="n">relerr</span> <span class="o">=</span> <span class="n">helpers</span><span class="o">.</span><span class="n">reduce_val</span><span class="p">(</span><span class="n">relerr</span><span class="p">,</span> <span class="n">op</span><span class="o">=</span><span class="n">constants</span><span class="o">.</span><span class="n">Reduce</span><span class="o">.</span><span class="n">SUM</span><span class="p">)</span>
    <span class="n">num_nodes</span> <span class="o">=</span> <span class="n">helpers</span><span class="o">.</span><span class="n">reduce_val</span><span class="p">(</span><span class="n">num_nodes</span><span class="p">,</span> <span class="n">op</span><span class="o">=</span><span class="n">constants</span><span class="o">.</span><span class="n">Reduce</span><span class="o">.</span><span class="n">SUM</span><span class="p">)</span>

<span class="c1"># output the results from one processor only</span>
<span class="k">if</span> <span class="n">ESMF</span><span class="o">.</span><span class="n">local_pet</span><span class="p">()</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
    <span class="n">meanrelerr</span> <span class="o">=</span> <span class="n">relerr</span> <span class="o">/</span> <span class="n">num_nodes</span>
    <span class="nb">print</span> <span class="p">(</span><span class="s2">&quot;ESMPy Grid Mesh Regridding Example&quot;</span><span class="p">)</span>
    <span class="nb">print</span> <span class="p">(</span><span class="s2">&quot;  interpolation mean relative error = </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">meanrelerr</span><span class="p">))</span>

    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">(),</span> <span class="n">filename</span><span class="p">)):</span>
        <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">(),</span> <span class="n">filename</span><span class="p">))</span>

<span class="c1"># set to 1 to output results</span>
<span class="c1"># if ESMF.pet_count() == 0:</span>
<span class="c1">#     import matplotlib.pyplot as plt</span>
<span class="c1">#     fig = plt.figure(1, (15, 6))</span>
<span class="c1">#     fig.suptitle(&#39;ESMPy Periodic Grids&#39;, fontsize=14, fontweight=&#39;bold&#39;)</span>
<span class="c1"># </span>
<span class="c1">#     ax = fig.add_subplot(1, 2, 1)</span>
<span class="c1">#     im = ax.imshow(srcfield.data, vmin=1, vmax=3, cmap=&#39;gist_ncar&#39;, aspect=&#39;auto&#39;,</span>
<span class="c1">#                    extent=[min(slons_par), max(slons_par), min(slats_par), max(slats_par)])</span>
<span class="c1">#     ax.set_xbound(lower=min(slons_par), upper=max(slons_par))</span>
<span class="c1">#     ax.set_ybound(lower=min(slats_par), upper=max(slats_par))</span>
<span class="c1">#     ax.set_xlabel(&quot;Longitude&quot;)</span>
<span class="c1">#     ax.set_ylabel(&quot;Latitude&quot;)</span>
<span class="c1">#     ax.set_title(&quot;Source Data&quot;)</span>
<span class="c1"># </span>
<span class="c1">#     ax = fig.add_subplot(1, 2, 2)</span>
<span class="c1">#     im = ax.imshow(dstfield.data, vmin=1, vmax=3, cmap=&#39;gist_ncar&#39;, aspect=&#39;auto&#39;,</span>
<span class="c1">#                    extent=[min(dlons_par), max(dlons_par), min(dlats_par), max(dlats_par)])</span>
<span class="c1">#     ax.set_xlabel(&quot;Longitude&quot;)</span>
<span class="c1">#     ax.set_ylabel(&quot;Latitude&quot;)</span>
<span class="c1">#     ax.set_title(&quot;Regrid Solution&quot;)</span>
<span class="c1"># </span>
<span class="c1">#     fig.subplots_adjust(right=0.8)</span>
<span class="c1">#     cbar_ax = fig.add_axes([0.9, 0.1, 0.01, 0.8])</span>
<span class="c1">#     fig.colorbar(im, cax=cbar_ax)</span>
<span class="c1"># </span>
<span class="c1">#     plt.show()</span>
</pre></div>
</div>
</div></blockquote>
</div>
<div class="section" id="grid-to-locstream">
<h3>Grid to LocStream<a class="headerlink" href="#grid-to-locstream" title="Permalink to this headline">¶</a></h3>
<blockquote>
<div><div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># This example demonstrates how to regrid between a Grid and a LocStream.</span>
<span class="c1"># The data files can be retrieved from the ESMF data repository by uncommenting the</span>
<span class="c1"># following block of code:</span>
<span class="c1">#</span>
<span class="c1"># import os</span>
<span class="c1"># DD = os.path.join(os.getcwd(), &quot;examples/data&quot;)</span>
<span class="c1"># if not os.path.isdir(DD):</span>
<span class="c1">#     os.makedirs(DD)</span>
<span class="c1"># from ESMF.util.cache_data import cache_data_file</span>
<span class="c1"># cache_data_file(os.path.join(DD, &quot;ll1deg_grid.nc&quot;))</span>

<span class="k">try</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">unittest</span> <span class="k">import</span> <span class="n">SkipTest</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">nose</span> <span class="k">import</span> <span class="n">SkipTest</span>

<span class="kn">import</span> <span class="nn">ESMF</span>
<span class="kn">import</span> <span class="nn">numpy</span>

<span class="kn">import</span> <span class="nn">ESMF.util.helpers</span> <span class="k">as</span> <span class="nn">helpers</span>
<span class="kn">import</span> <span class="nn">ESMF.api.constants</span> <span class="k">as</span> <span class="nn">constants</span>

<span class="c1"># This call enables debug logging</span>
<span class="n">ESMF</span><span class="o">.</span><span class="n">Manager</span><span class="p">(</span><span class="n">debug</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="kn">from</span> <span class="nn">ESMF.util.locstream_utilities</span> <span class="k">import</span> <span class="n">create_locstream_spherical_16</span><span class="p">,</span> <span class="n">create_locstream_spherical_16_parallel</span>
<span class="n">coord_sys</span><span class="o">=</span><span class="n">ESMF</span><span class="o">.</span><span class="n">CoordSys</span><span class="o">.</span><span class="n">SPH_DEG</span>
<span class="n">domask</span><span class="o">=</span><span class="kc">True</span>
<span class="k">if</span> <span class="n">ESMF</span><span class="o">.</span><span class="n">pet_count</span><span class="p">()</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
    <span class="n">locstream</span> <span class="o">=</span> <span class="n">create_locstream_spherical_16</span><span class="p">(</span><span class="n">coord_sys</span><span class="o">=</span><span class="n">coord_sys</span><span class="p">,</span> <span class="n">domask</span><span class="o">=</span><span class="n">domask</span><span class="p">)</span>
<span class="k">else</span><span class="p">:</span>
    <span class="k">if</span> <span class="n">constants</span><span class="o">.</span><span class="n">_ESMF_MPIRUN_NP</span> <span class="o">!=</span> <span class="mi">4</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">SkipTest</span><span class="p">(</span><span class="s1">&#39;processor count must be 4 or 1 for this example&#39;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">locstream</span> <span class="o">=</span> <span class="n">create_locstream_spherical_16_parallel</span><span class="p">(</span><span class="n">coord_sys</span><span class="o">=</span><span class="n">coord_sys</span><span class="p">,</span> <span class="n">domask</span><span class="o">=</span><span class="n">domask</span><span class="p">)</span>

<span class="n">grid1</span> <span class="o">=</span> <span class="s2">&quot;examples/data/ll1deg_grid.nc&quot;</span>
<span class="n">grid</span> <span class="o">=</span> <span class="n">ESMF</span><span class="o">.</span><span class="n">Grid</span><span class="p">(</span><span class="n">filename</span><span class="o">=</span><span class="n">grid1</span><span class="p">,</span> <span class="n">filetype</span><span class="o">=</span><span class="n">ESMF</span><span class="o">.</span><span class="n">FileFormat</span><span class="o">.</span><span class="n">SCRIP</span><span class="p">)</span>

<span class="c1"># create a field</span>
<span class="n">srcfield</span> <span class="o">=</span> <span class="n">ESMF</span><span class="o">.</span><span class="n">Field</span><span class="p">(</span><span class="n">grid</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;srcfield&#39;</span><span class="p">)</span>

<span class="n">dstfield</span> <span class="o">=</span> <span class="n">ESMF</span><span class="o">.</span><span class="n">Field</span><span class="p">(</span><span class="n">locstream</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;dstfield&#39;</span><span class="p">)</span>
<span class="n">xctfield</span> <span class="o">=</span> <span class="n">ESMF</span><span class="o">.</span><span class="n">Field</span><span class="p">(</span><span class="n">locstream</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;xctfield&#39;</span><span class="p">)</span>

<span class="c1"># initialize the fields</span>
<span class="p">[</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>
<span class="n">deg2rad</span> <span class="o">=</span> <span class="mf">3.14159</span><span class="o">/</span><span class="mi">180</span>

<span class="n">gridXCoord</span> <span class="o">=</span> <span class="n">srcfield</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">get_coords</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
<span class="n">gridYCoord</span> <span class="o">=</span> <span class="n">srcfield</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">get_coords</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
<span class="n">srcfield</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="o">...</span><span class="p">]</span> <span class="o">=</span> <span class="mf">10.0</span> <span class="o">+</span> <span class="n">numpy</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">gridXCoord</span> <span class="o">*</span> <span class="n">deg2rad</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">numpy</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">gridYCoord</span> <span class="o">*</span> <span class="n">deg2rad</span><span class="p">)</span>

<span class="n">gridXCoord</span> <span class="o">=</span> <span class="n">locstream</span><span class="p">[</span><span class="s2">&quot;ESMF:Lon&quot;</span><span class="p">]</span>
<span class="n">gridYCoord</span> <span class="o">=</span> <span class="n">locstream</span><span class="p">[</span><span class="s2">&quot;ESMF:Lat&quot;</span><span class="p">]</span>
<span class="k">if</span> <span class="n">coord_sys</span> <span class="o">==</span> <span class="n">ESMF</span><span class="o">.</span><span class="n">CoordSys</span><span class="o">.</span><span class="n">SPH_DEG</span><span class="p">:</span>
    <span class="n">xctfield</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="o">...</span><span class="p">]</span> <span class="o">=</span> <span class="mf">10.0</span> <span class="o">+</span> <span class="n">numpy</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">gridXCoord</span> <span class="o">*</span> <span class="n">deg2rad</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">numpy</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">gridYCoord</span> <span class="o">*</span> <span class="n">deg2rad</span><span class="p">)</span>
<span class="k">elif</span> <span class="n">coord_sys</span> <span class="o">==</span> <span class="n">ESMF</span><span class="o">.</span><span class="n">CoordSys</span><span class="o">.</span><span class="n">SPH_RAD</span><span class="p">:</span>
    <span class="n">xctfield</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="o">...</span><span class="p">]</span> <span class="o">=</span> <span class="mf">10.0</span> <span class="o">+</span> <span class="n">numpy</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">gridXCoord</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">numpy</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">gridYCoord</span><span class="p">)</span>
<span class="k">else</span><span class="p">:</span>
    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;coordsys value does not work in this example&quot;</span><span class="p">)</span>

<span class="n">dstfield</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="o">...</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1e20</span>

<span class="c1"># create an object to regrid data from the source to the destination field</span>
<span class="n">dst_mask_values</span><span class="o">=</span><span class="kc">None</span>
<span class="k">if</span> <span class="n">domask</span><span class="p">:</span>
    <span class="n">dst_mask_values</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">])</span>

<span class="n">regrid</span> <span class="o">=</span> <span class="n">ESMF</span><span class="o">.</span><span class="n">Regrid</span><span class="p">(</span><span class="n">srcfield</span><span class="p">,</span> <span class="n">dstfield</span><span class="p">,</span>
                     <span class="n">regrid_method</span><span class="o">=</span><span class="n">ESMF</span><span class="o">.</span><span class="n">RegridMethod</span><span class="o">.</span><span class="n">BILINEAR</span><span class="p">,</span>
                     <span class="n">unmapped_action</span><span class="o">=</span><span class="n">ESMF</span><span class="o">.</span><span class="n">UnmappedAction</span><span class="o">.</span><span class="n">ERROR</span><span class="p">,</span>
                     <span class="n">dst_mask_values</span><span class="o">=</span><span class="n">dst_mask_values</span><span class="p">)</span>

<span class="c1"># do the regridding from source to destination field</span>
<span class="n">dstfield</span> <span class="o">=</span> <span class="n">regrid</span><span class="p">(</span><span class="n">srcfield</span><span class="p">,</span> <span class="n">dstfield</span><span class="p">,</span> <span class="n">zero_region</span><span class="o">=</span><span class="n">ESMF</span><span class="o">.</span><span class="n">Region</span><span class="o">.</span><span class="n">SELECT</span><span class="p">)</span>

<span class="c1"># compute the mean relative error</span>
<span class="n">num_nodes</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">prod</span><span class="p">(</span><span class="n">xctfield</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[:])</span>
<span class="n">relerr</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">meanrelerr</span> <span class="o">=</span> <span class="mi">0</span>

<span class="n">dstfield</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ravel</span><span class="p">(</span><span class="n">dstfield</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
<span class="n">xctfield</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ravel</span><span class="p">(</span><span class="n">xctfield</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>

<span class="k">if</span> <span class="n">num_nodes</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
    <span class="n">ind</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">where</span><span class="p">((</span><span class="n">dstfield</span> <span class="o">!=</span> <span class="mf">1e20</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">xctfield</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">relerr</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">dstfield</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span> <span class="o">-</span> <span class="n">xctfield</span><span class="p">[</span><span class="n">ind</span><span class="p">])</span> <span class="o">/</span> <span class="n">numpy</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">xctfield</span><span class="p">[</span><span class="n">ind</span><span class="p">]))</span>
    <span class="n">meanrelerr</span> <span class="o">=</span> <span class="n">relerr</span> <span class="o">/</span> <span class="n">num_nodes</span>

<span class="c1"># handle the parallel case</span>
<span class="k">if</span> <span class="n">ESMF</span><span class="o">.</span><span class="n">pet_count</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
    <span class="n">relerr</span> <span class="o">=</span> <span class="n">helpers</span><span class="o">.</span><span class="n">reduce_val</span><span class="p">(</span><span class="n">relerr</span><span class="p">,</span> <span class="n">op</span><span class="o">=</span><span class="n">constants</span><span class="o">.</span><span class="n">Reduce</span><span class="o">.</span><span class="n">SUM</span><span class="p">)</span>
    <span class="n">num_nodes</span> <span class="o">=</span> <span class="n">helpers</span><span class="o">.</span><span class="n">reduce_val</span><span class="p">(</span><span class="n">num_nodes</span><span class="p">,</span> <span class="n">op</span><span class="o">=</span><span class="n">constants</span><span class="o">.</span><span class="n">Reduce</span><span class="o">.</span><span class="n">SUM</span><span class="p">)</span>

<span class="c1"># output the results from one processor only</span>
<span class="k">if</span> <span class="n">ESMF</span><span class="o">.</span><span class="n">local_pet</span><span class="p">()</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
    <span class="n">meanrelerr</span> <span class="o">=</span> <span class="n">relerr</span> <span class="o">/</span> <span class="n">num_nodes</span>
    <span class="nb">print</span> <span class="p">(</span><span class="s2">&quot;ESMPy Grid LocStream Regridding Example&quot;</span><span class="p">)</span>
    <span class="nb">print</span> <span class="p">(</span><span class="s2">&quot;  interpolation mean relative error = </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">meanrelerr</span><span class="p">))</span>

    <span class="k">assert</span> <span class="p">(</span><span class="n">meanrelerr</span> <span class="o">&lt;</span> <span class="mf">2e-2</span><span class="p">)</span>
</pre></div>
</div>
</div></blockquote>
</div>
<div class="section" id="mesh-to-locstream">
<h3>Mesh to LocStream<a class="headerlink" href="#mesh-to-locstream" title="Permalink to this headline">¶</a></h3>
<blockquote>
<div><div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># This example demonstrates how to regrid between a mesh and a locstream.</span>

<span class="k">try</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">unittest</span> <span class="k">import</span> <span class="n">SkipTest</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">nose</span> <span class="k">import</span> <span class="n">SkipTest</span>

<span class="kn">import</span> <span class="nn">ESMF</span>
<span class="kn">import</span> <span class="nn">numpy</span>

<span class="kn">import</span> <span class="nn">ESMF.util.helpers</span> <span class="k">as</span> <span class="nn">helpers</span>
<span class="kn">import</span> <span class="nn">ESMF.api.constants</span> <span class="k">as</span> <span class="nn">constants</span>

<span class="c1"># This call enables debug logging</span>
<span class="c1"># ESMF.Manager(debug=True)</span>

<span class="kn">from</span> <span class="nn">ESMF.util.mesh_utilities</span> <span class="k">import</span> <span class="n">mesh_create_5</span><span class="p">,</span> <span class="n">mesh_create_5_parallel</span>
<span class="kn">from</span> <span class="nn">ESMF.util.locstream_utilities</span> <span class="k">import</span> <span class="n">create_locstream_16</span><span class="p">,</span> <span class="n">create_locstream_16_parallel</span>
<span class="k">if</span> <span class="n">ESMF</span><span class="o">.</span><span class="n">pet_count</span><span class="p">()</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
    <span class="n">mesh</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">mesh_create_5</span><span class="p">()</span>
    <span class="n">locstream</span> <span class="o">=</span> <span class="n">create_locstream_16</span><span class="p">()</span>
<span class="k">else</span><span class="p">:</span>
    <span class="k">if</span> <span class="n">constants</span><span class="o">.</span><span class="n">_ESMF_MPIRUN_NP</span> <span class="o">!=</span> <span class="mi">4</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">SkipTest</span><span class="p">(</span><span class="s1">&#39;processor count must be 4 or 1 for this example&#39;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">mesh</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">mesh_create_5_parallel</span><span class="p">()</span>
        <span class="n">locstream</span> <span class="o">=</span> <span class="n">create_locstream_16_parallel</span><span class="p">()</span>

<span class="c1"># create a field</span>
<span class="n">srcfield</span> <span class="o">=</span> <span class="n">ESMF</span><span class="o">.</span><span class="n">Field</span><span class="p">(</span><span class="n">mesh</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;srcfield&#39;</span><span class="p">)</span><span class="c1">#, meshloc=ESMF.MeshLoc.ELEMENT)</span>

<span class="c1"># create a field on the locstream</span>
<span class="n">dstfield</span> <span class="o">=</span> <span class="n">ESMF</span><span class="o">.</span><span class="n">Field</span><span class="p">(</span><span class="n">locstream</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;dstfield&#39;</span><span class="p">)</span>
<span class="n">xctfield</span> <span class="o">=</span> <span class="n">ESMF</span><span class="o">.</span><span class="n">Field</span><span class="p">(</span><span class="n">locstream</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;xctfield&#39;</span><span class="p">)</span>

<span class="c1"># initialize the fields</span>
<span class="p">[</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>
<span class="n">deg2rad</span> <span class="o">=</span> <span class="mf">3.14159</span><span class="o">/</span><span class="mi">180</span>

<span class="n">gridXCoord</span> <span class="o">=</span> <span class="n">srcfield</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">get_coords</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
<span class="n">gridYCoord</span> <span class="o">=</span> <span class="n">srcfield</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">get_coords</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
<span class="n">srcfield</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="o">...</span><span class="p">]</span> <span class="o">=</span> <span class="mf">10.0</span> <span class="o">+</span> <span class="p">(</span><span class="n">gridXCoord</span> <span class="o">*</span> <span class="n">deg2rad</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="n">gridYCoord</span> <span class="o">*</span> <span class="n">deg2rad</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span>

<span class="n">gridXCoord</span> <span class="o">=</span> <span class="n">locstream</span><span class="p">[</span><span class="s2">&quot;ESMF:X&quot;</span><span class="p">]</span>
<span class="n">gridYCoord</span> <span class="o">=</span> <span class="n">locstream</span><span class="p">[</span><span class="s2">&quot;ESMF:Y&quot;</span><span class="p">]</span>
<span class="n">xctfield</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="o">...</span><span class="p">]</span> <span class="o">=</span> <span class="mf">10.0</span> <span class="o">+</span> <span class="p">(</span><span class="n">gridXCoord</span> <span class="o">*</span> <span class="n">deg2rad</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="n">gridYCoord</span> <span class="o">*</span> <span class="n">deg2rad</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span>

<span class="n">dstfield</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="o">...</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1e20</span>

<span class="c1"># create an object to regrid data from the source to the destination field</span>
<span class="c1"># TODO: this example seems to fail occasionally with UnmappedAction.ERROR, probably due to a tolerance issue - ask Bob</span>
<span class="n">regrid</span> <span class="o">=</span> <span class="n">ESMF</span><span class="o">.</span><span class="n">Regrid</span><span class="p">(</span><span class="n">srcfield</span><span class="o">=</span><span class="n">srcfield</span><span class="p">,</span> <span class="n">dstfield</span><span class="o">=</span><span class="n">dstfield</span><span class="p">,</span> <span class="n">regrid_method</span><span class="o">=</span><span class="n">ESMF</span><span class="o">.</span><span class="n">RegridMethod</span><span class="o">.</span><span class="n">BILINEAR</span><span class="p">,</span>
                     <span class="n">unmapped_action</span><span class="o">=</span><span class="n">ESMF</span><span class="o">.</span><span class="n">UnmappedAction</span><span class="o">.</span><span class="n">IGNORE</span><span class="p">)</span>

<span class="c1"># do the regridding from source to destination field</span>
<span class="n">dstfield</span> <span class="o">=</span> <span class="n">regrid</span><span class="p">(</span><span class="n">srcfield</span><span class="p">,</span> <span class="n">dstfield</span><span class="p">)</span>

<span class="c1"># compute the mean relative error</span>
<span class="n">num_nodes</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">prod</span><span class="p">(</span><span class="n">xctfield</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[:])</span>
<span class="n">relerr</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">meanrelerr</span> <span class="o">=</span> <span class="mi">0</span>
<span class="k">if</span> <span class="n">num_nodes</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
    <span class="n">ind</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">where</span><span class="p">((</span><span class="n">dstfield</span><span class="o">.</span><span class="n">data</span> <span class="o">!=</span> <span class="mf">1e20</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">xctfield</span><span class="o">.</span><span class="n">data</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">relerr</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">dstfield</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span> <span class="o">-</span> <span class="n">xctfield</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">ind</span><span class="p">])</span> <span class="o">/</span> <span class="n">numpy</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">xctfield</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">ind</span><span class="p">]))</span>
    <span class="n">meanrelerr</span> <span class="o">=</span> <span class="n">relerr</span> <span class="o">/</span> <span class="n">num_nodes</span>

<span class="c1"># handle the parallel case</span>
<span class="k">if</span> <span class="n">ESMF</span><span class="o">.</span><span class="n">pet_count</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
    <span class="n">relerr</span> <span class="o">=</span> <span class="n">helpers</span><span class="o">.</span><span class="n">reduce_val</span><span class="p">(</span><span class="n">relerr</span><span class="p">,</span> <span class="n">op</span><span class="o">=</span><span class="n">constants</span><span class="o">.</span><span class="n">Reduce</span><span class="o">.</span><span class="n">SUM</span><span class="p">)</span>
    <span class="n">num_nodes</span> <span class="o">=</span> <span class="n">helpers</span><span class="o">.</span><span class="n">reduce_val</span><span class="p">(</span><span class="n">num_nodes</span><span class="p">,</span> <span class="n">op</span><span class="o">=</span><span class="n">constants</span><span class="o">.</span><span class="n">Reduce</span><span class="o">.</span><span class="n">SUM</span><span class="p">)</span>

<span class="c1"># output the results from one processor only</span>
<span class="k">if</span> <span class="n">ESMF</span><span class="o">.</span><span class="n">local_pet</span><span class="p">()</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
    <span class="n">meanrelerr</span> <span class="o">=</span> <span class="n">relerr</span> <span class="o">/</span> <span class="n">num_nodes</span>
    <span class="nb">print</span> <span class="p">(</span><span class="s2">&quot;ESMPy Grid Mesh Regridding Example&quot;</span><span class="p">)</span>
    <span class="nb">print</span> <span class="p">(</span><span class="s2">&quot;  interpolation mean relative error = </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">meanrelerr</span><span class="p">))</span>

    <span class="k">assert</span> <span class="p">(</span><span class="n">meanrelerr</span> <span class="o">&lt;</span> <span class="mf">3e-5</span><span class="p">)</span>
</pre></div>
</div>
</div></blockquote>
</div>
<div class="section" id="locstream-to-grid">
<h3>LocStream to Grid<a class="headerlink" href="#locstream-to-grid" title="Permalink to this headline">¶</a></h3>
<blockquote>
<div><div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># This example demonstrates how to regrid between a LocStream and a Grid.</span>
<span class="c1"># The data files can be retrieved from the ESMF data repository by uncommenting the</span>
<span class="c1"># following block of code:</span>
<span class="c1">#</span>
<span class="c1"># import os</span>
<span class="c1"># DD = os.path.join(os.getcwd(), &quot;examples/data&quot;)</span>
<span class="c1"># if not os.path.isdir(DD):</span>
<span class="c1">#     os.makedirs(DD)</span>
<span class="c1"># from ESMF.util.cache_data import cache_data_file</span>
<span class="c1"># cache_data_file(os.path.join(DD, &quot;ll1deg_grid.nc&quot;))</span>

<span class="k">try</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">unittest</span> <span class="k">import</span> <span class="n">SkipTest</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">nose</span> <span class="k">import</span> <span class="n">SkipTest</span>

<span class="kn">import</span> <span class="nn">ESMF</span>
<span class="kn">import</span> <span class="nn">numpy</span>

<span class="kn">import</span> <span class="nn">ESMF.util.helpers</span> <span class="k">as</span> <span class="nn">helpers</span>
<span class="kn">import</span> <span class="nn">ESMF.api.constants</span> <span class="k">as</span> <span class="nn">constants</span>

<span class="c1"># This call enables debug logging</span>
<span class="n">ESMF</span><span class="o">.</span><span class="n">Manager</span><span class="p">(</span><span class="n">debug</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="n">grid1</span> <span class="o">=</span> <span class="s2">&quot;examples/data/ll1deg_grid.nc&quot;</span>
<span class="n">grid</span> <span class="o">=</span> <span class="n">ESMF</span><span class="o">.</span><span class="n">Grid</span><span class="p">(</span><span class="n">filename</span><span class="o">=</span><span class="n">grid1</span><span class="p">,</span> <span class="n">filetype</span><span class="o">=</span><span class="n">ESMF</span><span class="o">.</span><span class="n">FileFormat</span><span class="o">.</span><span class="n">SCRIP</span><span class="p">)</span>

<span class="kn">from</span> <span class="nn">ESMF.util.locstream_utilities</span> <span class="k">import</span> <span class="n">create_locstream_spherical_16</span><span class="p">,</span> <span class="n">create_locstream_spherical_16_parallel</span>
<span class="n">coord_sys</span><span class="o">=</span><span class="n">ESMF</span><span class="o">.</span><span class="n">CoordSys</span><span class="o">.</span><span class="n">SPH_DEG</span>
<span class="n">domask</span><span class="o">=</span><span class="kc">True</span>
<span class="k">if</span> <span class="n">ESMF</span><span class="o">.</span><span class="n">pet_count</span><span class="p">()</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
    <span class="n">locstream</span> <span class="o">=</span> <span class="n">create_locstream_spherical_16</span><span class="p">(</span><span class="n">coord_sys</span><span class="o">=</span><span class="n">coord_sys</span><span class="p">,</span> <span class="n">domask</span><span class="o">=</span><span class="n">domask</span><span class="p">)</span>
<span class="k">else</span><span class="p">:</span>
    <span class="k">if</span> <span class="n">constants</span><span class="o">.</span><span class="n">_ESMF_MPIRUN_NP</span> <span class="o">!=</span> <span class="mi">4</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">SkipTest</span><span class="p">(</span><span class="s1">&#39;processor count must be 4 or 1 for this example&#39;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">locstream</span> <span class="o">=</span> <span class="n">create_locstream_spherical_16_parallel</span><span class="p">(</span><span class="n">coord_sys</span><span class="o">=</span><span class="n">coord_sys</span><span class="p">,</span> <span class="n">domask</span><span class="o">=</span><span class="n">domask</span><span class="p">)</span>

<span class="c1"># create a field</span>
<span class="n">srcfield</span> <span class="o">=</span> <span class="n">ESMF</span><span class="o">.</span><span class="n">Field</span><span class="p">(</span><span class="n">locstream</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;srcfield&#39;</span><span class="p">)</span>

<span class="n">dstfield</span> <span class="o">=</span> <span class="n">ESMF</span><span class="o">.</span><span class="n">Field</span><span class="p">(</span><span class="n">grid</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;dstfield&#39;</span><span class="p">)</span>
<span class="n">xctfield</span> <span class="o">=</span> <span class="n">ESMF</span><span class="o">.</span><span class="n">Field</span><span class="p">(</span><span class="n">grid</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;xctfield&#39;</span><span class="p">)</span>

<span class="c1"># initialize the fields</span>
<span class="p">[</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>
<span class="n">deg2rad</span> <span class="o">=</span> <span class="mf">3.14159</span><span class="o">/</span><span class="mi">180</span>

<span class="n">gridXCoord</span> <span class="o">=</span> <span class="n">locstream</span><span class="p">[</span><span class="s2">&quot;ESMF:Lon&quot;</span><span class="p">]</span>
<span class="n">gridYCoord</span> <span class="o">=</span> <span class="n">locstream</span><span class="p">[</span><span class="s2">&quot;ESMF:Lat&quot;</span><span class="p">]</span>
<span class="k">if</span> <span class="n">coord_sys</span> <span class="o">==</span> <span class="n">ESMF</span><span class="o">.</span><span class="n">CoordSys</span><span class="o">.</span><span class="n">SPH_DEG</span><span class="p">:</span>
    <span class="n">srcfield</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="o">...</span><span class="p">]</span> <span class="o">=</span> <span class="mf">10.0</span> <span class="o">+</span> <span class="n">numpy</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">gridXCoord</span> <span class="o">*</span> <span class="n">deg2rad</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">numpy</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">gridYCoord</span> <span class="o">*</span> <span class="n">deg2rad</span><span class="p">)</span>
<span class="k">elif</span> <span class="n">coord_sys</span> <span class="o">==</span> <span class="n">ESMF</span><span class="o">.</span><span class="n">CoordSys</span><span class="o">.</span><span class="n">SPH_RAD</span><span class="p">:</span>
    <span class="n">srcfield</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="o">...</span><span class="p">]</span> <span class="o">=</span> <span class="mf">10.0</span> <span class="o">+</span> <span class="n">numpy</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">gridXCoord</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">numpy</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">gridYCoord</span><span class="p">)</span>
<span class="k">else</span><span class="p">:</span>
    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;coordsys value does not apply in this example&quot;</span><span class="p">)</span>

<span class="n">gridXCoord</span> <span class="o">=</span> <span class="n">xctfield</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">get_coords</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
<span class="n">gridYCoord</span> <span class="o">=</span> <span class="n">xctfield</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">get_coords</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
<span class="n">xctfield</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="o">...</span><span class="p">]</span> <span class="o">=</span> <span class="mf">10.0</span> <span class="o">+</span> <span class="n">numpy</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">gridXCoord</span> <span class="o">*</span> <span class="n">deg2rad</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">numpy</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">gridYCoord</span> <span class="o">*</span> <span class="n">deg2rad</span><span class="p">)</span>


<span class="n">dstfield</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="o">...</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1e20</span>

<span class="c1"># create an object to regrid data from the source to the destination field</span>
<span class="n">mask_values</span><span class="o">=</span><span class="kc">None</span>
<span class="k">if</span> <span class="n">domask</span><span class="p">:</span>
    <span class="n">mask_values</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">])</span>

<span class="n">regrid</span> <span class="o">=</span> <span class="n">ESMF</span><span class="o">.</span><span class="n">Regrid</span><span class="p">(</span><span class="n">srcfield</span><span class="p">,</span> <span class="n">dstfield</span><span class="p">,</span>
                     <span class="n">regrid_method</span><span class="o">=</span><span class="n">ESMF</span><span class="o">.</span><span class="n">RegridMethod</span><span class="o">.</span><span class="n">NEAREST_DTOS</span><span class="p">,</span>
                     <span class="n">unmapped_action</span><span class="o">=</span><span class="n">ESMF</span><span class="o">.</span><span class="n">UnmappedAction</span><span class="o">.</span><span class="n">ERROR</span><span class="p">,</span>
                     <span class="n">src_mask_values</span><span class="o">=</span><span class="n">mask_values</span><span class="p">)</span>

<span class="c1"># do the regridding from source to destination field</span>
<span class="n">dstfield</span> <span class="o">=</span> <span class="n">regrid</span><span class="p">(</span><span class="n">srcfield</span><span class="p">,</span> <span class="n">dstfield</span><span class="p">,</span> <span class="n">zero_region</span><span class="o">=</span><span class="n">ESMF</span><span class="o">.</span><span class="n">Region</span><span class="o">.</span><span class="n">SELECT</span><span class="p">)</span>

<span class="c1"># compute the mean relative error</span>
<span class="kn">from</span> <span class="nn">operator</span> <span class="k">import</span> <span class="n">mul</span>
<span class="n">num_nodes</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">prod</span><span class="p">(</span><span class="n">xctfield</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[:])</span>
<span class="n">relerr</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">meanrelerr</span> <span class="o">=</span> <span class="mi">0</span>

<span class="n">dstfield</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ravel</span><span class="p">(</span><span class="n">dstfield</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
<span class="n">xctfield</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ravel</span><span class="p">(</span><span class="n">xctfield</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>

<span class="k">if</span> <span class="n">num_nodes</span> <span class="ow">is</span> <span class="ow">not</span> <span class="mi">0</span><span class="p">:</span>
    <span class="n">ind</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">where</span><span class="p">((</span><span class="n">dstfield</span> <span class="o">!=</span> <span class="mf">1e20</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">xctfield</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">relerr</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">dstfield</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span> <span class="o">-</span> <span class="n">xctfield</span><span class="p">[</span><span class="n">ind</span><span class="p">])</span> <span class="o">/</span> <span class="n">numpy</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">xctfield</span><span class="p">[</span><span class="n">ind</span><span class="p">]))</span>
    <span class="n">meanrelerr</span> <span class="o">=</span> <span class="n">relerr</span> <span class="o">/</span> <span class="n">num_nodes</span>

<span class="c1"># handle the parallel case</span>
<span class="k">if</span> <span class="n">ESMF</span><span class="o">.</span><span class="n">pet_count</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
    <span class="n">relerr</span> <span class="o">=</span> <span class="n">helpers</span><span class="o">.</span><span class="n">reduce_val</span><span class="p">(</span><span class="n">relerr</span><span class="p">,</span> <span class="n">op</span><span class="o">=</span><span class="n">constants</span><span class="o">.</span><span class="n">Reduce</span><span class="o">.</span><span class="n">SUM</span><span class="p">)</span>
    <span class="n">num_nodes</span> <span class="o">=</span> <span class="n">helpers</span><span class="o">.</span><span class="n">reduce_val</span><span class="p">(</span><span class="n">num_nodes</span><span class="p">,</span> <span class="n">op</span><span class="o">=</span><span class="n">constants</span><span class="o">.</span><span class="n">Reduce</span><span class="o">.</span><span class="n">SUM</span><span class="p">)</span>

<span class="c1"># output the results from one processor only</span>
<span class="k">if</span> <span class="n">ESMF</span><span class="o">.</span><span class="n">local_pet</span><span class="p">()</span> <span class="ow">is</span> <span class="mi">0</span><span class="p">:</span>
    <span class="n">meanrelerr</span> <span class="o">=</span> <span class="n">relerr</span> <span class="o">/</span> <span class="n">num_nodes</span>
    <span class="nb">print</span> <span class="p">(</span><span class="s2">&quot;ESMPy LocStream Grid Regridding Example&quot;</span><span class="p">)</span>
    <span class="nb">print</span> <span class="p">(</span><span class="s2">&quot;  interpolation mean relative error = </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">meanrelerr</span><span class="p">))</span>

    <span class="k">assert</span> <span class="p">(</span><span class="n">meanrelerr</span> <span class="o">&lt;</span> <span class="mf">9e-5</span><span class="p">)</span>
</pre></div>
</div>
</div></blockquote>
</div>
<div class="section" id="using-mpi-spawn-from-a-serial-python-driver">
<h3>Using MPI.Spawn() from a Serial Python Driver<a class="headerlink" href="#using-mpi-spawn-from-a-serial-python-driver" title="Permalink to this headline">¶</a></h3>
<blockquote>
<div><div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># This example demonstrates how to call ESMPy regridding as a parallel</span>
<span class="c1"># subprocess spawned using mpi4py from a serial Python driver.</span>
<span class="c1">#</span>
<span class="c1"># NOTE: MPI.COMM_WORLD.Spawn does not seem to work for mpi4py installations</span>
<span class="c1">#       installations built with mpich, however openmpi does work (July 2016).</span>
<span class="c1">#</span>
<span class="c1"># The data files can be retrieved from the ESMF data repository by uncommenting the</span>
<span class="c1"># following block of code:</span>
<span class="c1">#</span>
<span class="c1"># import os</span>
<span class="c1"># DD = os.path.join(os.getcwd(), &quot;examples/data&quot;)</span>
<span class="c1"># if not os.path.isdir(DD):</span>
<span class="c1">#     os.makedirs(DD)</span>
<span class="c1"># from ESMF.util.cache_data import cache_data_file</span>
<span class="c1"># cache_data_file(os.path.join(DD, &quot;ll1deg_grid.nc&quot;))</span>
<span class="c1"># cache_data_file(os.path.join(DD, &quot;mpas_uniform_10242_dual_counterclockwise.nc&quot;))</span>

<span class="kn">import</span> <span class="nn">numpy</span>
<span class="kn">from</span> <span class="nn">mpi4py</span> <span class="k">import</span> <span class="n">MPI</span>
<span class="kn">import</span> <span class="nn">sys</span>

<span class="k">def</span> <span class="nf">regrid</span><span class="p">():</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="kn">import</span> <span class="nn">ESMF</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ImportError</span><span class="p">(</span><span class="s2">&quot;ESMF is not available on this machine&quot;</span><span class="p">)</span>

    <span class="n">grid1</span> <span class="o">=</span> <span class="s2">&quot;examples/data/ll1deg_grid.nc&quot;</span>
    <span class="n">grid2</span> <span class="o">=</span> <span class="s2">&quot;examples/data/mpas_uniform_10242_dual_counterclockwise.nc&quot;</span>

    <span class="c1"># Create a uniform global latlon grid from a SCRIP formatted file</span>
    <span class="n">grid</span> <span class="o">=</span> <span class="n">ESMF</span><span class="o">.</span><span class="n">Grid</span><span class="p">(</span><span class="n">filename</span><span class="o">=</span><span class="n">grid1</span><span class="p">,</span> <span class="n">filetype</span><span class="o">=</span><span class="n">ESMF</span><span class="o">.</span><span class="n">FileFormat</span><span class="o">.</span><span class="n">SCRIP</span><span class="p">)</span>
    <span class="c1"># NOTE: corners are needed for conservative regridding</span>
    <span class="c1"># grid = ESMF.Grid(filename=grid1, filetype=ESMF.FileFormat.SCRIP,</span>
    <span class="c1">#                  add_corner_stagger=True)</span>

    <span class="c1"># create a field on the center stagger locations of the source grid</span>
    <span class="n">srcfield</span> <span class="o">=</span> <span class="n">ESMF</span><span class="o">.</span><span class="n">Field</span><span class="p">(</span><span class="n">grid</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;srcfield&#39;</span><span class="p">,</span>
                          <span class="n">staggerloc</span><span class="o">=</span><span class="n">ESMF</span><span class="o">.</span><span class="n">StaggerLoc</span><span class="o">.</span><span class="n">CENTER</span><span class="p">)</span>

    <span class="c1"># create an ESMF formatted unstructured mesh with clockwise cells removed</span>
    <span class="n">mesh</span> <span class="o">=</span> <span class="n">ESMF</span><span class="o">.</span><span class="n">Mesh</span><span class="p">(</span><span class="n">filename</span><span class="o">=</span><span class="n">grid2</span><span class="p">,</span> <span class="n">filetype</span><span class="o">=</span><span class="n">ESMF</span><span class="o">.</span><span class="n">FileFormat</span><span class="o">.</span><span class="n">ESMFMESH</span><span class="p">)</span>

    <span class="c1"># create a field on the nodes of the destination mesh</span>
    <span class="n">dstfield</span> <span class="o">=</span> <span class="n">ESMF</span><span class="o">.</span><span class="n">Field</span><span class="p">(</span><span class="n">mesh</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;dstfield&#39;</span><span class="p">,</span> <span class="n">meshloc</span><span class="o">=</span><span class="n">ESMF</span><span class="o">.</span><span class="n">MeshLoc</span><span class="o">.</span><span class="n">NODE</span><span class="p">)</span>
    <span class="n">xctfield</span> <span class="o">=</span> <span class="n">ESMF</span><span class="o">.</span><span class="n">Field</span><span class="p">(</span><span class="n">mesh</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;xctfield&#39;</span><span class="p">,</span> <span class="n">meshloc</span><span class="o">=</span><span class="n">ESMF</span><span class="o">.</span><span class="n">MeshLoc</span><span class="o">.</span><span class="n">NODE</span><span class="p">)</span>
    <span class="c1"># NOTE: Field must be built on elements of Mesh for conservative regridding</span>
    <span class="c1"># dstfield = ESMF.Field(mesh, name=&#39;dstfield&#39;, meshloc=ESMF.MeshLoc.ELEMENT)</span>
    <span class="c1"># xctfield = ESMF.Field(mesh, name=&#39;xctfield&#39;, meshloc=ESMF.MeshLoc.ELEMENT)</span>

    <span class="c1"># initialize the fields</span>
    <span class="p">[</span><span class="n">lon</span><span class="p">,</span> <span class="n">lat</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>
    <span class="n">deg2rad</span> <span class="o">=</span> <span class="mf">3.14159</span> <span class="o">/</span> <span class="mi">180</span>

    <span class="n">gridXCoord</span> <span class="o">=</span> <span class="n">srcfield</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">get_coords</span><span class="p">(</span><span class="n">lon</span><span class="p">,</span> <span class="n">ESMF</span><span class="o">.</span><span class="n">StaggerLoc</span><span class="o">.</span><span class="n">CENTER</span><span class="p">)</span>
    <span class="n">gridYCoord</span> <span class="o">=</span> <span class="n">srcfield</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">get_coords</span><span class="p">(</span><span class="n">lat</span><span class="p">,</span> <span class="n">ESMF</span><span class="o">.</span><span class="n">StaggerLoc</span><span class="o">.</span><span class="n">CENTER</span><span class="p">)</span>
    <span class="n">srcfield</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="o">...</span><span class="p">]</span> <span class="o">=</span> <span class="mf">10.0</span> <span class="o">+</span> <span class="p">(</span><span class="n">gridXCoord</span> <span class="o">*</span> <span class="n">deg2rad</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">+</span> <span class="p">(</span>
                                                              <span class="n">gridYCoord</span> <span class="o">*</span> <span class="n">deg2rad</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span>

    <span class="n">gridXCoord</span> <span class="o">=</span> <span class="n">xctfield</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">get_coords</span><span class="p">(</span><span class="n">lon</span><span class="p">,</span> <span class="n">ESMF</span><span class="o">.</span><span class="n">StaggerLoc</span><span class="o">.</span><span class="n">CENTER</span><span class="p">)</span>
    <span class="n">gridYCoord</span> <span class="o">=</span> <span class="n">xctfield</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">get_coords</span><span class="p">(</span><span class="n">lat</span><span class="p">,</span> <span class="n">ESMF</span><span class="o">.</span><span class="n">StaggerLoc</span><span class="o">.</span><span class="n">CENTER</span><span class="p">)</span>
    <span class="n">xctfield</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="o">...</span><span class="p">]</span> <span class="o">=</span> <span class="mf">10.0</span> <span class="o">+</span> <span class="p">(</span><span class="n">gridXCoord</span> <span class="o">*</span> <span class="n">deg2rad</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">+</span> <span class="p">(</span>
                                                              <span class="n">gridYCoord</span> <span class="o">*</span> <span class="n">deg2rad</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span>

    <span class="n">dstfield</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="o">...</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1e20</span>

    <span class="c1"># create an object to regrid data from the source to the destination field</span>
    <span class="n">regrid</span> <span class="o">=</span> <span class="n">ESMF</span><span class="o">.</span><span class="n">Regrid</span><span class="p">(</span><span class="n">srcfield</span><span class="p">,</span> <span class="n">dstfield</span><span class="p">,</span>
                         <span class="n">regrid_method</span><span class="o">=</span><span class="n">ESMF</span><span class="o">.</span><span class="n">RegridMethod</span><span class="o">.</span><span class="n">BILINEAR</span><span class="p">,</span>
                         <span class="n">unmapped_action</span><span class="o">=</span><span class="n">ESMF</span><span class="o">.</span><span class="n">UnmappedAction</span><span class="o">.</span><span class="n">ERROR</span><span class="p">)</span>

    <span class="c1"># do the regridding from source to destination field</span>
    <span class="n">dstfield</span> <span class="o">=</span> <span class="n">regrid</span><span class="p">(</span><span class="n">srcfield</span><span class="p">,</span> <span class="n">dstfield</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">dstfield</span><span class="p">,</span> <span class="n">xctfield</span>

<span class="k">def</span> <span class="nf">compute_error</span><span class="p">(</span><span class="n">dstfield</span><span class="p">,</span> <span class="n">xctfield</span><span class="p">):</span>
    <span class="c1"># compute the mean relative error</span>
    <span class="kn">from</span> <span class="nn">operator</span> <span class="k">import</span> <span class="n">mul</span>
    <span class="n">num_nodes</span> <span class="o">=</span> <span class="n">reduce</span><span class="p">(</span><span class="n">mul</span><span class="p">,</span> <span class="n">xctfield</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
    <span class="n">relerr</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">meanrelerr</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">if</span> <span class="n">num_nodes</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">ind</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">where</span><span class="p">((</span><span class="n">dstfield</span> <span class="o">!=</span> <span class="mf">1e20</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">xctfield</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">relerr</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span>
            <span class="n">numpy</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">dstfield</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span> <span class="o">-</span> <span class="n">xctfield</span><span class="p">[</span><span class="n">ind</span><span class="p">])</span> <span class="o">/</span> <span class="n">numpy</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span>
                <span class="n">xctfield</span><span class="p">[</span><span class="n">ind</span><span class="p">]))</span>
        <span class="n">meanrelerr</span> <span class="o">=</span> <span class="n">relerr</span> <span class="o">/</span> <span class="n">num_nodes</span>

    <span class="n">meanrelerr</span> <span class="o">=</span> <span class="n">relerr</span> <span class="o">/</span> <span class="n">num_nodes</span>
    <span class="nb">print</span> <span class="s2">&quot;ESMPy regridding as a spawned MPI process:&quot;</span>
    <span class="nb">print</span> <span class="s2">&quot;  interpolation mean relative error = </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">meanrelerr</span><span class="p">)</span>


<span class="c1">########################################### MAIN #############################</span>

<span class="n">start_worker</span> <span class="o">=</span> <span class="s1">&#39;worker&#39;</span>
<span class="n">usage</span> <span class="o">=</span> <span class="s1">&#39;Program should be started without arguments&#39;</span>
<span class="n">pet_count</span> <span class="o">=</span> <span class="mi">4</span>

<span class="c1"># Parent</span>
<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>

    <span class="c1"># Spawn workers</span>
    <span class="n">comm</span> <span class="o">=</span> <span class="n">MPI</span><span class="o">.</span><span class="n">COMM_WORLD</span><span class="o">.</span><span class="n">Spawn</span><span class="p">(</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">executable</span><span class="p">,</span>
        <span class="n">args</span><span class="o">=</span><span class="p">[</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">start_worker</span><span class="p">],</span>
        <span class="n">maxprocs</span><span class="o">=</span><span class="n">pet_count</span><span class="p">)</span>

    <span class="c1"># gather output fields from workers</span>
    <span class="n">dstfield</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">dstfield</span> <span class="o">=</span> <span class="n">comm</span><span class="o">.</span><span class="n">gather</span><span class="p">(</span><span class="n">dstfield</span><span class="p">,</span> <span class="n">root</span><span class="o">=</span><span class="n">MPI</span><span class="o">.</span><span class="n">ROOT</span><span class="p">)</span>
    <span class="n">dstfield</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">dstfield</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">pet_count</span><span class="p">)])</span>

    <span class="n">xctfield</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">xctfield</span> <span class="o">=</span> <span class="n">comm</span><span class="o">.</span><span class="n">gather</span><span class="p">(</span><span class="n">xctfield</span><span class="p">,</span> <span class="n">root</span><span class="o">=</span><span class="n">MPI</span><span class="o">.</span><span class="n">ROOT</span><span class="p">)</span>
    <span class="n">xctfield</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">xctfield</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">pet_count</span><span class="p">)])</span>

    <span class="c1"># plot results</span>
    <span class="n">compute_error</span><span class="p">(</span><span class="n">dstfield</span><span class="p">,</span> <span class="n">xctfield</span><span class="p">)</span>

    <span class="c1"># Shutdown</span>
    <span class="n">comm</span><span class="o">.</span><span class="n">Disconnect</span><span class="p">()</span>

<span class="c1"># Worker</span>
<span class="k">elif</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="n">start_worker</span><span class="p">:</span>

    <span class="c1"># Connect to parent</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">comm</span> <span class="o">=</span> <span class="n">MPI</span><span class="o">.</span><span class="n">Comm</span><span class="o">.</span><span class="n">Get_parent</span><span class="p">()</span>
        <span class="n">rank</span> <span class="o">=</span> <span class="n">comm</span><span class="o">.</span><span class="n">Get_rank</span><span class="p">()</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Could not connect to parent - &#39;</span> <span class="o">+</span> <span class="n">usage</span><span class="p">)</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="c1"># call ESMPy regridding</span>
        <span class="n">dstfield</span><span class="p">,</span> <span class="n">xctfield</span> <span class="o">=</span> <span class="n">regrid</span><span class="p">()</span>

        <span class="c1"># send output to parent</span>
        <span class="n">comm</span><span class="o">.</span><span class="n">gather</span><span class="p">(</span><span class="n">sendobj</span><span class="o">=</span><span class="n">dstfield</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">root</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">comm</span><span class="o">.</span><span class="n">gather</span><span class="p">(</span><span class="n">sendobj</span><span class="o">=</span><span class="n">xctfield</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">root</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="n">comm</span><span class="o">.</span><span class="n">Disconnect</span><span class="p">()</span>

    <span class="c1"># Shutdown</span>
    <span class="n">comm</span><span class="o">.</span><span class="n">Disconnect</span><span class="p">()</span>

<span class="c1"># Catch</span>
<span class="k">else</span><span class="p">:</span>
    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">usage</span><span class="p">)</span>
</pre></div>
</div>
</div></blockquote>
</div>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
  <h3><a href="index.html">Table of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">Tutorials</a><ul>
<li><a class="reference internal" href="#hello-world">Hello World</a></li>
<li><a class="reference internal" href="#regridding-helper-functions">Regridding Helper Functions</a><ul>
<li><a class="reference internal" href="#locstream-create">LocStream Create</a></li>
<li><a class="reference internal" href="#locstream-create-parallel">LocStream Create Parallel</a></li>
<li><a class="reference internal" href="#create-a-2d-grid">Create a 2D Grid</a></li>
<li><a class="reference internal" href="#create-a-3d-grid">Create a 3D Grid</a></li>
<li><a class="reference internal" href="#create-a-periodic-grid">Create a Periodic Grid</a></li>
<li><a class="reference internal" href="#create-a-5-element-mesh">Create a 5 Element Mesh</a></li>
<li><a class="reference internal" href="#create-a-field">Create a Field</a></li>
<li><a class="reference internal" href="#initialize-an-analytic-field">Initialize an Analytic Field</a></li>
<li><a class="reference internal" href="#run-esmpy-regridding">Run ESMPy Regridding</a></li>
<li><a class="reference internal" href="#compute-field-mass">Compute Field Mass</a></li>
</ul>
</li>
<li><a class="reference internal" href="#regridding">Regridding</a><ul>
<li><a class="reference internal" href="#grid-mesh-and-field-created-from-file">Grid, Mesh and Field Created from File</a></li>
<li><a class="reference internal" href="#read-and-write-a-weight-file">Read and Write a Weight File</a></li>
<li><a class="reference internal" href="#grid-to-locstream">Grid to LocStream</a></li>
<li><a class="reference internal" href="#mesh-to-locstream">Mesh to LocStream</a></li>
<li><a class="reference internal" href="#locstream-to-grid">LocStream to Grid</a></li>
<li><a class="reference internal" href="#using-mpi-spawn-from-a-serial-python-driver">Using MPI.Spawn() from a Serial Python Driver</a></li>
</ul>
</li>
</ul>
</li>
</ul>

  <h4>Previous topic</h4>
  <p class="topless"><a href="install.html"
                        title="previous chapter">Installation</a></p>
  <h4>Next topic</h4>
  <p class="topless"><a href="api.html"
                        title="next chapter">API</a></p>
  <div role="note" aria-label="source link">
    <h3>This Page</h3>
    <ul class="this-page-menu">
      <li><a href="_sources/examples.rst.txt"
            rel="nofollow">Show Source</a></li>
    </ul>
   </div>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    </div>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="api.html" title="API"
             >next</a> |</li>
        <li class="right" >
          <a href="install.html" title="Installation"
             >previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="index.html">ESMPy 8.1.0 beta snapshot documentation</a> &#187;</li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &#169; Copyright 2011-2020, University Corporation for Atmospheric Research, Massachusetts Institute of Technology, Geophysical Fluid Dynamics Laboratory, University of Michigan, National Centers for Environmental Prediction, Los Alamos National Laboratory, Argonne National Laboratory, NASA Goddard Space Flight Center.  Licensed under the University of Illinois-NCSA License.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.8.3.
    </div>
  </body>
</html>